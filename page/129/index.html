<!DOCTYPE html><html lang="zh-Hans"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="人若无名，方可潜心练剑"><meta name="keywords" content><meta name="author" content="Mochazz"><meta name="copyright" content="Mochazz"><title>七月火 | Mochazz's blog</title><link rel="shortcut icon" href="/favicon.png"><link rel="stylesheet" href="/css/index.css?version=1.6.1"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.6.1"><link rel="dns-prefetch" href="https://cdn.staticfile.org"><link rel="dns-prefetch" href="https://cdn.bootcss.com"><link rel="dns-prefetch" href="https://creativecommons.org"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  }
} </script></head><body><canvas class="fireworks"></canvas><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar"><div class="author-info"><div class="author-info__avatar text-center"><img src="/img/avatar.jpg"></div><div class="author-info__name text-center">Mochazz</div><div class="author-info__description text-center">人若无名，方可潜心练剑</div><div class="follow-button"><a href="https://github.com/Mochazz">Follow Me</a></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">220</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">81</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">分类</span><span class="pull-right">20</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">Links</div><a class="author-info-links__name text-center" href="http://www.lmxspace.com">l1nk3r</a><a class="author-info-links__name text-center" href="https://www.virzz.com">Virink</a><a class="author-info-links__name text-center" href="https://www.kingkk.com">kingkk</a><a class="author-info-links__name text-center" href="https://hpdoger.cn">hpdoger</a><a class="author-info-links__name text-center" href="https://www.smi1e.top">smi1e</a><a class="author-info-links__name text-center" href="http://m4p1e.com">maple</a><a class="author-info-links__name text-center" href="https://zhzhdoai.github.io">osword</a><a class="author-info-links__name text-center" href="https://nikoeurus.github.io">Somnus</a><a class="author-info-links__name text-center" href="https://landgrey.me">LandGrey</a><a class="author-info-links__name text-center" href="https://www.cnpanda.net">panda</a><a class="author-info-links__name text-center" href="http://foreversong.cn">ADog</a></div></div></div><nav id="nav" style="background-image: url(/img/backgroud.jpeg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Mochazz's blog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus"><a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/about">About</a><a class="site-page" href="/read">Read</a></span></div><div id="site-info"><div id="site-title">Mochazz's blog</div><div id="site-sub-title">七月火</div></div></nav><div id="content-outer"><div class="layout" id="content-inner"><div class="recent-post-item article-container"><a class="article-title" href="/2018/09/12/代码审计Day11 - unserialize反序列化漏洞/">代码审计Day11 - unserialize反序列化漏洞</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2018-09-12</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/代码审计/">代码审计</a></span><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/PHP-Audit-Labs/">PHP-Audit-Labs</a></span><div class="content"><p>本文由红日安全成员： <strong>licong</strong> 编写，如有不当，还望斧正。</p>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>大家好，我们是红日安全-代码审计小组。最近我们小组正在做一个PHP代码审计的项目，供大家学习交流，我们给这个项目起了一个名字叫 <a href="https://github.com/hongriSec/PHP-Audit-Labs" target="_blank" rel="noopener"><strong>PHP-Audit-Labs</strong></a> 。现在大家所看到的系列文章，属于项目 <strong>第一阶段</strong> 的内容，本阶段的内容题目均来自 <a href="https://www.ripstech.com/php-security-calendar-2017/" target="_blank" rel="noopener">PHP SECURITY CALENDAR 2017</a> 。对于每一道题目，我们均给出对应的分析，并结合实际CMS进行解说。在文章的最后，我们还会留一道CTF题目，供大家练习，希望大家喜欢。下面是 <strong>第11篇</strong> 代码审计文章：</p>
<h2 id="Day-11-Pumpkin-Pie"><a href="#Day-11-Pumpkin-Pie" class="headerlink" title="Day 11 - Pumpkin Pie"></a>Day 11 - Pumpkin Pie</h2><p>题目如下：</p>
<p><img src="/img/PHP-Audit-Labs/Day11/1.png" alt></p>
<p><strong>漏洞解析：</strong> (上图代码第11行正则表达式应改为：’/O:\d:/‘)</p>
<p>题目考察对php反序列化函数的利用。在第10行 <strong>loadData()</strong> 函数中，我们发现了 <strong>unserialize</strong> 函数对传入的 <strong>$data</strong> 变量进行了反序列。在反序列化前，对变量内容进行了判断，先不考虑绕过，跟踪一下变量，看看变量是否可控。在代码 <strong>第6行</strong> ，调用了 <strong>loadData()</strong> 函数，<code>$data</code>变量来自于 <strong>__construct()</strong> 构造函数传入的变量。代码第32行，对 <strong>Template</strong> 类进行了实例化，并将 <strong>cookie</strong> 中键为’data’数据作为初始化数据进行传入，<code>$data</code>数据我们可控。开始考虑绕过对传入数据的判断。</p>
<p>代码 <strong>11行</strong> ，第一个if，截取前两个字符，判断反序列化内容是否为对象，如果为对象，返回为空。php可反序列化类型有String,Integer,Boolean,Null,Array,Object。去除掉Object后，考虑采用数组中存储对象进行绕过。</p>
<p>第二个if判断,匹配 字符串为 &#39;O:任意十进制:’,将对象放入数组进行反序列化后，仍然能够匹配到，返回为空，考虑一下如何绕过正则匹配，PHP反序列化处理部分源码如下：</p>
<p><img src="/img/PHP-Audit-Labs/Day11/2.png" alt="2"></p>
<p><img src="/img/PHP-Audit-Labs/Day11/3.png" alt="3"></p>
<p><img src="/img/PHP-Audit-Labs/Day11/4.png" alt="4"></p>
<p>在PHP源码var_unserializer.c，对反序列化字符串进行处理，在代码568行对字符进行判断，并调用相应的函数进行处理，当字符为’O’时，调用 <strong>yy13</strong> 函数，在 <strong>yy13</strong> 函数中，对‘O‘字符的下一个字符进行判断，如果是’:’,则调用 <strong>yy17</strong> 函数,如果不是则调用 <strong>yy3</strong> 函数,直接return 0，结束反序列化。接着看 <strong>yy17</strong> 函数。通过观察yybm[]数组可知，第一个if判断是否为数字，如果为数字则跳转到 <strong>yy20</strong> 函数，第二个判断如果是’+’号则跳转到 <strong>yy19</strong> ，在 <strong>yy19</strong> 中，继续对 <strong>+号</strong> 后面的字符进行判断，如果为数字则跳转到 <strong>yy20</strong> ,如果不是则跳转到 <strong>yy18</strong> ， <strong>y18</strong> 最终跳转到 <strong>yy3</strong> ，退出反序列化流程。由此，在’O:’,后面可以增加’+’，用来绕过正则判断。</p>
<p>绕过了过滤以后，接下来考虑怎样对反序列化进行利用，反序列化本质是将序列化的字符串还原成对应的类实例，在该过程中，我们可控的是序列化字符串的内容，也就是对应类中变量的值。我们无法直接调用类中的函数，但PHP在满足一定的条件下，会自动触发一些函数的调用，该类函数，我们称为魔术方法。通过可控的类变量，触发自动调用的魔术方法，以及魔术方法中存在的可利用点，进而形成反序列化漏洞的利用。</p>
<p>在代码31行，对象销毁时会调用 <strong>createCache()</strong> 函数，函数将 <code>$template</code> 中的内容放到了 <code>$cacheFile</code> 对应的文件中。 <strong>file_put_contents()</strong> 函数，当文件不存在时，会创建该文件。由此可构造一句话，写入当前路径。</p>
<p> <code>$cacheFile</code> 和 <code>$template</code> 为类变量，反序列化可控，由此，构造以下反序列化内容，别忘了加’+’号</p>
<p><img src="/img/PHP-Audit-Labs/Day11/5.png" alt="5"></p>
<p>放入cookie需进行URL编码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a:<span class="number">1</span>:&#123;i:<span class="number">0</span>;O:+<span class="number">8</span>:<span class="string">"Template"</span>:<span class="number">2</span>:&#123;s:<span class="number">9</span>:<span class="string">"cacheFile"</span>;s:<span class="number">10</span>:<span class="string">"./test.php"</span>;s:<span class="number">8</span>:<span class="string">"template"</span>;s:<span class="number">25</span>:<span class="string">"&lt;?php eval($_POST[xx]);?&gt;"</span>;&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>文件成功写入：</p>
<p><img src="/img/PHP-Audit-Labs/Day11/6.png" alt="6"></p>
<h2 id="实例分析"><a href="#实例分析" class="headerlink" title="实例分析"></a>实例分析</h2><p>本次实例分析，选取的是 <strong>Typecho-1.1</strong> 版本，在该版本中，用户可通过反序列化Cookie数据进行前台Getshell。该漏洞出现于 <strong>install.php</strong> 文件 <strong>230行</strong> ，具体代码如下：</p>
<p><img src="/img/PHP-Audit-Labs/Day11/7.png" alt="7"></p>
<p>在上图代码 <strong>第3行</strong> ，对Cookie中的数据base64解码以后，进行了反序列化操作，该值可控，接下来看一下代码触发条件。文件几个关键判断如下：</p>
<p><img src="/img/PHP-Audit-Labs/Day11/8.png" alt="8"></p>
<p>第一个if判断，可通过GET传递 <strong>finish=任意值</strong> 绕过 ，第二if判断是否有GET或者POST传参，并判断Referer是否为空，第四个if判断Referer是否为本站点。紧接着还有判断，如下图：</p>
<p><img src="/img/PHP-Audit-Labs/Day11/9.png" alt="9"></p>
<p>第一个if判断 <strong>$_GET[‘finish’]</strong> 是否设置，然后判断 <strong>config.inc.php文件</strong> 是否存在，安装后已存在，第三个判断cookie中 <strong>__typecho_config</strong> 参数是否为空，不为空。进入else分支。综上，具体构造如下图：</p>
<p><img src="/img/PHP-Audit-Labs/Day11/10.png" alt="10"></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$config = unserialize(base64_decode(Typecho_Cookie::get(<span class="string">'__typecho_config'</span>)));</span><br><span class="line">Typecho_Cookie::delete(<span class="string">'__typecho_config'</span>);</span><br><span class="line">$db = <span class="keyword">new</span> Typecho_Db($config[<span class="string">'adapter'</span>], $config[<span class="string">'prefix'</span>]);</span><br></pre></td></tr></table></figure>

<p>反序列化结果存储到 <strong>$config</strong> 变量中，然后将 <strong>$config[‘adapter’]</strong> 和 <strong>$config[‘prefix’]</strong> 作为 <strong>Typecho_Db</strong> 类的初始化变量创建类实例。我们可以在 <strong>var/Typecho/Db.php</strong> 文件中找到该类构造函数代码，具体如下：</p>
<p><img src="/img/PHP-Audit-Labs/Day11/11.png" alt="11"></p>
<p>上图代码 <strong>第6行</strong> ，对传入的 <strong>$adapterName</strong> 变量进行了字符串拼接操作，对于PHP而言，如果 <strong>$adapterName</strong> 类型为对象，则会调用该类 <strong>__toString()</strong> 魔术方法。可作为反序列化的一个触发点，我们全局搜索一下 <strong>__toString()</strong> ，查看是否有可利用的点。实际搜索时，会发现有三个类都定义了 <strong>__toString()</strong> 方法：</p>
<p><img src="/img/PHP-Audit-Labs/Day11/19.png" alt="19"></p>
<ul>
<li><p>第一处 <strong>var\Typecho\Config.php</strong>：</p>
<p><img src="/img/PHP-Audit-Labs/Day11/12.png" alt="12"></p>
<p>调用 <strong>serialize()</strong> 函数进行序列化操作，会自动触发 <strong>__sleep()</strong> ，如果存在可利用的 <strong>__sleep()</strong> ，则可以进一步利用。</p>
</li>
<li><p>第二处 <strong>var\Typecho\Db\Query.php</strong>：<br><img src="/img/PHP-Audit-Labs/Day11/13.png" alt="13"></p>
<p>该方法用于构建SQL语句，并没有执行数据库操作，所以暂无利用价值。</p>
</li>
<li><p>第三处<strong>var\Typecho\Feed.php</strong>：</p>
<p><img src="/img/PHP-Audit-Labs/Day11/14.png" alt="14"></p>
<p>在代码 <strong>19行</strong> ， <strong>$this-&gt;_items</strong> 为类变量，反序列化可控，在代码 <strong>27行</strong> ， <strong>$item[‘author’]-&gt;screenName</strong> ，如果 <strong>$item[‘author’]</strong> 中存储的类没有’screenName’属性或该属性为私有属性，此时会触发该类中的 <strong>__get()</strong> 魔法方法，这个可作为进一步利用的点，继续往下看代码，未发现有危险函数的调用。</p>
</li>
</ul>
<p>记一波魔术方法及对应的触发条件，具体如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">__wakeup() <span class="comment">//使用unserialize时触发</span></span><br><span class="line">__sleep() <span class="comment">//使用serialize时触发</span></span><br><span class="line">__destruct() <span class="comment">//对象被销毁时触发</span></span><br><span class="line">__call() <span class="comment">//在对象上下文中调用不可访问的方法时触发</span></span><br><span class="line">__callStatic() <span class="comment">//在静态上下文中调用不可访问的方法时触发</span></span><br><span class="line">__get() <span class="comment">//用于从不可访问的属性读取数据</span></span><br><span class="line">__set() <span class="comment">//用于将数据写入不可访问的属性</span></span><br><span class="line">__isset() <span class="comment">//在不可访问的属性上调用isset()或empty()触发</span></span><br><span class="line">__unset() <span class="comment">//在不可访问的属性上使用unset()时触发</span></span><br><span class="line">__toString() <span class="comment">//把类当作字符串使用时触发</span></span><br><span class="line">__invoke() <span class="comment">//当脚本尝试将对象调用为函数时触发</span></span><br></pre></td></tr></table></figure>

<p>在 <strong>var/Typecho/Request.php</strong> 的  <strong>Typecho_Request</strong> 类中，我们发现 <strong>__get()</strong> 方法，跟踪该方法的调用，具体如下图：<img src="/img/PHP-Audit-Labs/Day11/15.png" alt="15"></p>
<p> <strong>array_map()</strong> 函数和 <strong>call_user_func</strong> 函数，都可以作为利用点，<strong>$filter</strong> 作为调用函数，<strong>$value</strong> 为函数参数，跟踪变量,看一下是否可控。这两个变量都来源于类变量，反序列化可控。从上面的分析中，可知当 <strong>$item[‘author’]</strong> 满足一定条件会触发 <strong>__get</strong> 方法。</p>
<p>假设 <strong>$item[‘author’]</strong> 中存储 <strong>Typecho_Request</strong> 类实例，此时调用 <strong>$item[‘author’]-&gt;screenName</strong> ，在<strong>Typecho_Request</strong> 类中没有该属性，就会调用类中的 <strong>__get($key)</strong> 方法，<strong>$key</strong> 传入的值为 <strong>scrrenName</strong> 。参数传递过程如下：<code>$key=&#39;scrrenName&#39;</code>=&gt;<code>$this-&gt;_param[$key]</code>=&gt;<code>$value</code></p>
<p>我们将 <strong>$this-&gt;_param[‘scrrenName’]</strong> 的值设置为想要执行的函数，构造 <strong>$this-&gt;_filter</strong> 为对应函数的参数值，具体构造如下：</p>
<p><img src="/img/PHP-Audit-Labs/Day11/16.png" alt="16"></p>
<p>接下来我们去看一下 <strong>Typecho_Feed</strong> 类的构造，该类在 <strong>var/Typecho/Feed.php</strong> 文件中，代码如下：</p>
<p><img src="/img/PHP-Audit-Labs/Day11/14.png" alt="14"></p>
<p>上图代码 <strong>第7行</strong> ，满足 <strong>self::RSS2</strong> 与 <strong>$this-&gt;_type</strong> 相等进入该分支，所以 <strong>$this-&gt;_type</strong> 需要构造，<strong>item[‘author’]</strong> 为触发点，需要构造 <strong>$this_items</strong> ，具体构造如下：</p>
<p><img src="/img/PHP-Audit-Labs/Day11/17.png" alt="17"></p>
<p>代码 <strong>22行</strong> 在实际利用没必要添加，install.php在代码 <strong>54行</strong> 调用 <strong>ob_start()</strong> 函数，该函数对输出内容进行缓冲,反序列化漏洞利用结束后，在<strong>var\Typecho\Db.php</strong>代码121行，触发异常，在 <strong>var\Typecho\Common.php</strong> 代码237行调用 <strong>ob_end_clean()函数</strong> 清除了缓冲区内容，导致无法看见执行结果，考虑在进入到异常处理前提前报错结束程序。由此构造该数据。执行结果如下： </p>
<p><img src="/img/PHP-Audit-Labs/Day11/18.png" alt="18"></p>
<h2 id="修复建议"><a href="#修复建议" class="headerlink" title="修复建议"></a>修复建议</h2><p>造成该漏洞的原因主要有两点：</p>
<ul>
<li>当 <strong>config.inc.php</strong> 文件存在的时，可绕过判断继续往下执行代码。</li>
<li>传入反序列化函数的参数可控</li>
</ul>
<p>修复方法：在 <strong>install.php</strong> 文件第一行判断 <strong>config.inc.php</strong> 是否存在，如果存在，则退出代码执行。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="keyword">if</span> (file_exists(dirname(<span class="keyword">__FILE__</span>) . <span class="string">'/config.inc.php'</span>))</span><br><span class="line">    <span class="keyword">exit</span>(<span class="string">'Access Denied'</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h2><p>看完了上述分析，不知道大家是否对反序列化利用有了一定的了解，文中用到的CMS可以从 <a href="https://github.com/typecho/typecho/archive/v1.1-15.5.12-beta.zip" target="_blank" rel="noopener">这里</a> 下载，当然文中若有不当之处，还望各位斧正。如果你对我们的项目感兴趣，欢迎发送邮件到 <a href="mailto:hongrisec@gmail.com" target="_blank" rel="noopener">hongrisec@gmail.com</a> 联系我们。<strong>Day11</strong> 的分析文章就到这里，我们最后留了一道CTF题目给大家练手，题目如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">"config.php"</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HITCON</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $method;</span><br><span class="line">    <span class="keyword">public</span> $args;</span><br><span class="line">    <span class="keyword">public</span> $conn;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($method, $args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;method = $method;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;args = $args;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;__conn();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__conn</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">global</span> $db_host, $db_name, $db_user, $db_pass, $DEBUG;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">$this</span>-&gt;conn)</span><br><span class="line">            <span class="keyword">$this</span>-&gt;conn = mysql_connect($db_host, $db_user, $db_pass);</span><br><span class="line">        mysql_select_db($db_name, <span class="keyword">$this</span>-&gt;conn);</span><br><span class="line">        <span class="keyword">if</span> ($DEBUG) &#123;</span><br><span class="line">            $sql = <span class="string">"DROP TABLE IF  EXISTS  users"</span>;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;__query($sql, $back=<span class="keyword">false</span>);</span><br><span class="line">            $sql = <span class="string">"CREATE TABLE IF NOT EXISTS users (username VARCHAR(64),</span></span><br><span class="line"><span class="string">            password VARCHAR(64),role VARCHAR(256)) CHARACTER SET utf8"</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">$this</span>-&gt;__query($sql, $back=<span class="keyword">false</span>);</span><br><span class="line">            $sql = <span class="string">"INSERT INTO users VALUES ('orange', '$db_pass', 'admin'), ('phddaa', 'ddaa', 'user')"</span>;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;__query($sql, $back=<span class="keyword">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        mysql_query(<span class="string">"SET names utf8"</span>);</span><br><span class="line">        mysql_query(<span class="string">"SET sql_mode = 'strict_all_tables'"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__query</span><span class="params">($sql, $back=true)</span> </span>&#123;</span><br><span class="line">        $result = @mysql_query($sql);</span><br><span class="line">        <span class="keyword">if</span> ($back) &#123;</span><br><span class="line">            <span class="keyword">return</span> @mysql_fetch_object($result);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">login</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">list</span>($username, $password) = func_get_args();</span><br><span class="line">        $sql = sprintf(<span class="string">"SELECT * FROM users WHERE username='%s' AND password='%s'"</span>, $username, md5($password));</span><br><span class="line">        $obj = <span class="keyword">$this</span>-&gt;__query($sql);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ( $obj != <span class="keyword">false</span> ) &#123;</span><br><span class="line">            define(<span class="string">'IN_FLAG'</span>, <span class="keyword">TRUE</span>);</span><br><span class="line">            <span class="keyword">$this</span>-&gt;loadData($obj-&gt;role);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="keyword">$this</span>-&gt;__die(<span class="string">"sorry!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">loadData</span><span class="params">($data)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (substr($data, <span class="number">0</span>, <span class="number">2</span>) !== <span class="string">'O:'</span> &amp;&amp; !preg_match(<span class="string">'/O:\d:/'</span>, $data)) &#123;</span><br><span class="line">            <span class="keyword">return</span> unserialize($data);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> [];</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__die</span><span class="params">($msg)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;__close();</span><br><span class="line">        header(<span class="string">"Content-Type: application/json"</span>);</span><br><span class="line">        <span class="keyword">die</span>( json_encode( <span class="keyword">array</span>(<span class="string">"msg"</span>=&gt; $msg) ) );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__close</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        mysql_close(<span class="keyword">$this</span>-&gt;conn);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">source</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;__conn();</span><br><span class="line">        <span class="keyword">if</span> (in_array(<span class="keyword">$this</span>-&gt;method, <span class="keyword">array</span>(<span class="string">"login"</span>, <span class="string">"source"</span>))) &#123;</span><br><span class="line">            @call_user_func_array(<span class="keyword">array</span>(<span class="keyword">$this</span>, <span class="keyword">$this</span>-&gt;method), <span class="keyword">$this</span>-&gt;args);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;__die(<span class="string">"What do you do?"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;__close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">foreach</span>(<span class="keyword">$this</span>-&gt;args <span class="keyword">as</span> $k =&gt; $v) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;args[$k] = strtolower(trim(mysql_escape_string($v)));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SoFun</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $file=<span class="string">'index.php'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;file)) &#123;</span><br><span class="line">            <span class="keyword">include</span> <span class="keyword">$this</span>-&gt;file;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span><span class="params">()</span></span>&#123;</span><br><span class="line">    	<span class="keyword">$this</span>-&gt; file=<span class="string">'index.php'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">"data"</span>])) &#123;</span><br><span class="line">    @unserialize($_GET[<span class="string">"data"</span>]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">new</span> HITCON(<span class="string">"source"</span>, <span class="keyword">array</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//config.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    $db_host = <span class="string">'localhost'</span>;</span><br><span class="line">    $db_name = <span class="string">'test'</span>;</span><br><span class="line">    $db_user = <span class="string">'root'</span>;</span><br><span class="line">    $db_pass = <span class="string">'123'</span>;</span><br><span class="line">	$DEBUG = <span class="string">'xx'</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// flag.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">!defined(<span class="string">'IN_FLAG'</span>) &amp;&amp; <span class="keyword">exit</span>(<span class="string">'Access Denied'</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"flag&#123;un3eri@liz3_i3_s0_fun&#125;"</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

</div><hr></div><nav id="pagination"><div class="pagination"><a class="extend prev" rel="prev" href="/page/128/"><i class="fa fa-chevron-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/128/">128</a><span class="page-number current">129</span><a class="page-number" href="/page/130/">130</a><span class="space">&hellip;</span><a class="page-number" href="/page/220/">220</a><a class="extend next" rel="next" href="/page/130/"><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer class="footer-bg" style="background-image: url(/img/backgroud.jpeg)"><div class="layout" id="footer"><div class="copyright">&copy;2017 - 2020 By Mochazz</div><div class="framework-info"><span>驱动 - </span><a href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_site_uv"><i class="fa fa-user"></i><span id="busuanzi_value_site_uv"></span><span></span></span><span class="footer-separator">|</span><span id="busuanzi_container_site_pv"><i class="fa fa-eye"></i><span id="busuanzi_value_site_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.6.1"></script><script src="/js/fancybox.js?version=1.6.1"></script><script src="/js/sidebar.js?version=1.6.1"></script><script src="/js/copy.js?version=1.6.1"></script><script src="/js/fireworks.js?version=1.6.1"></script><script src="/js/transition.js?version=1.6.1"></script><script src="/js/scroll.js?version=1.6.1"></script><script src="/js/head.js?version=1.6.1"></script><script>if(/Android|webOS|iPhone|iPod|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
}</script></body></html>